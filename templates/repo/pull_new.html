{% extends "repo/repo.html" %}
{% block subcontainer %}
<style>
.repo-refs { border: 1px solid #D4D4D4; padding: 10px }    
</style>
<div>
    <h4 style="margin: 10px"><a href="/{{user_name}}/{{repo_name}}/pulls/">{{repo_name}}</a> /
        <span id="i_repo_path"></span>
        <span>创建一个合并请求</span>
    </h4>
    <!--create pull request-->
    <div class="row" style="margin-top: 20px">
        <div class="span10">
            <div class="span4 repo-refs">
                <span>仓库：</span>
                <select id="id_source_repo" class="span3">
                    {% for repo in pull_repo_list %}
                        {% if repo.id == source_repo.id %}
                            <option selected="selected" value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
                        {% else %}
                            <option value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <br/>
                <span>分支：</span>
                <select id="id_source_refs" class="span3">
                </select>
            </div>
            <div class="span0">
                <i class="icon-chevron-right"></i>
            </div>
            <div class="span4 repo-refs">
                <span>仓库：</span>
                <select id="id_desc_repo" class="span3">
                    {% for repo in pull_repo_list %}
                        {% if repo.username == desc_repo.username and repo.name == desc_repo.name %}
                            <option selected="selected" value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
                        {% else %}
                            <option value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <br/>
                <span>分支：</span>
                <select id="id_desc_refs" class="span3">
                </select>
            </div>
        </div>
        <div id="id_pull_div" class="span9" style="margin-top: 20px; margin-bottom: 0px">
            <form id="id_pull_form" method="post" action="" class="form-horizontal">
                <div style="display:none"><input id="id_source_repo_select" type="hidden" value="" name="source_repo"></div>
                <div style="display:none"><input id="id_source_refs_select" type="hidden" value="" name="source_refs"></div>
                <div style="display:none"><input id="id_desc_repo_select" type="hidden" value="" name="desc_repo"></div>
                <div style="display:none"><input id="id_desc_refs_select" type="hidden" value="" name="desc_refs"></div>
                <fieldset>
                    <div class="control-group">
                        <label class="control-label" for="id_title">* 标题</label>
                        <div class="controls">
                            <input id="id_title" name="title" style="width: 500px;" type="text" maxlength="64" placeholder="输入标题，说明此次Pull Request的主要更改。">
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="id_desc">描述</label>
                        <div class="controls">
                            <textarea id="id_desc" name="desc" style="height: 200px; width: 500px;" rows="10" cols="40" maxlength="2048"></textarea>
                        </div>
                    </div>
                    <div id="id_alert" class="alert hide">
                        <a class="close" data-dismiss="alert">×</a>
                        <span>* 请输入标题，选择来源仓库、分支和目标仓库、分支</span>
                    </div>
                    <div id="id_submit" style="margin-left: 160px">
                        <a class="muted" data-original-title=" 出于礼貌，提前合并目标分支代码，减少对方合并时出现冲突的可能性" rel="tooltip" href="javascript: void(0)"><button type="submit" class="btn btn-primary" id="id_pull_submit">创建合并请求</button></a>
                    </div>
                </fieldset>
                <div style="display:none"><input type="hidden" value="{{ csrf_token }}" name="csrfmiddlewaretoken"></div>
            </form>
        </div>
    </div>
    <div style="margin-top: 20px">
        <ul class="nav nav-tabs" style="margin-bottom: 10px">
            <li id="id_commits_nav" class="c_pull_request_action active" data-action="commit"><a href="javascript:void(0)">Commits</a></li>
            <li id="id_diff_nav" class="c_pull_request_action" data-action="diff"><a href="javascript:void(0)">Diff</a></li>
        </ul>
        <div id="id_pull_meta_data">
            <div id="id_ajax_loading" class="c_pull_request_content"><img style="margin-left: 50px" src='/static/img/loading.gif'></div>
            <div id="id_pull_request_commit" class="c_pull_request_content hide"></div>
            <div id="id_pull_request_diff" class="c_pull_request_content hide"></div>
        </div>
    </div>
</div>		  
{% endblock %}
{% block subjs %}
<script src='/static/js/app/syntaxhighlighter/shCore.js' type='text/javascript'></script>
<script src='/static/js/app/syntaxhighlighter/shAutoloader.js' type='text/javascript'></script>
<script src='/static/js/app/syntaxhighlighter/shBrushDiff.js' type='text/javascript'></script>
<script>
$(function(){
    var global_repo_branch_map = {};
    $('.c_unixtime').each(function(index){ 
        $(this).html(moment(new Date($(this).html()*1000)).fromNow());
        $(this).show();
    });
    $('#id_submit').tooltip({
      selector: "a[rel=tooltip]"
    });
    var load_commit_meta = function() {
        $('.c_pull_request_action').each(function(index){
            $(this).removeClass('active');
        });
        $('#id_commits_nav').show();
        $('#id_commits_nav').addClass('active');
        var source_repo = $('#id_source_repo option:selected').val();
        var source_refs = $('#id_source_refs option:selected').val();
        var desc_repo = $('#id_desc_repo option:selected').val();
        var desc_refs  = $('#id_desc_refs option:selected').val();
        var source_username = source_repo.split('/')[0];
        var desc_username = desc_repo.split('/')[0];
        $.post('/{{user_name}}/{{repo_name}}/pull/commits/'+source_username+':'+source_refs+'...'+desc_username+':'+desc_refs+'/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            var html = [];
            var is_up_to_date = false;
            var source_commit_hash = json.source_repo_refs_commit_hash.substr(0, 7);
            var desc_commit_hash = json.desc_repo_refs_commit_hash.substr(0, 7);
            var exists_commit_hash_map = {};
            exists_commit_hash_map[desc_commit_hash] = 1
            var up_to_date = '<p>Already up-to-date. 你并不需要进行合并操作</p>';
            if(json.commits.length > 0) {
                html.push('<table class="table table-striped"><thead class="fixed"><tr><th width="20%">提交HASH (作者)</th><th width="10%">时间</th><th>日志</th></tr></thead><tbody>');
                for(x in json.commits) {
                    var commit_hash = json.commits[x].commit_hash;
                    if(commit_hash in exists_commit_hash_map) {
                        var tmp_parent_commit_hashs = json.commits[x].parent_commit_hash.split(' ')
                        for(y in tmp_parent_commit_hashs) {
                            exists_commit_hash_map[tmp_parent_commit_hashs[y]] = 1;
                        }
                    }
                    var committer = json.commits[x].committer;
                    var committer_date = json.commits[x].committer_date;
                    var committer_moment = moment(new Date(committer_date*1000)).fromNow();
                    var commit_message = json.commits[x].commit_message;
                    html.push('<tr><td><code>' + commit_hash + '</code><span>(' + committer + ')</span></td><td><span style="display: inline;">' + committer_moment + '</span></td><td>' + commit_message + '</td></tr>');
                }
                html.push('</tbody></table>');
            } else {
                html.push(up_to_date);
            }
            if(source_commit_hash in exists_commit_hash_map) {
                is_up_to_date = true;
            }
            $('.c_pull_request_content').each(function(index){
                $(this).hide();
             });
            if(is_up_to_date) {
                $('#id_pull_request_commit').html(up_to_date);
                $('#id_pull_div').hide();
            } else {
                $('#id_pull_request_commit').html(html.join(''));
                $('#id_pull_div').show();
            }
            $('#id_pull_request_commit').show();
        });
    }
    var load_diff_meta = function() {
        $('.c_pull_request_action').each(function(index){
            $(this).removeClass('active');
        });
        $('#id_diff_nav').show();
        $('#id_diff_nav').addClass('active');
        var source_repo = $('#id_source_repo option:selected').val();
        var source_refs = $('#id_source_refs option:selected').val();
        var desc_repo = $('#id_desc_repo option:selected').val();
        var desc_refs  = $('#id_desc_refs option:selected').val();
        var source_username = source_repo.split('/')[0];
        var desc_username = desc_repo.split('/')[0];
        $.post('/{{user_name}}/{{repo_name}}/pull/diff/'+source_username+':'+source_refs+'..'+desc_username+':'+desc_refs+'/3/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            var diff = json.diff;
            $('.c_pull_request_content').each(function(index){
                $(this).hide();
            });
            $('#id_pull_request_diff').html('<pre class="brush: diff;">' + diff + '</pre>');
            SyntaxHighlighter.highlight();
            $('#id_pull_request_diff').show();
        });
    }
    $('.c_pull_request_action').click(function(){
        var action = $(this).data('action');
        $('.c_pull_request_action').each(function(index){
            $(this).removeClass('active');
        });
        $(this).addClass('active');
        $('.c_pull_request_content').each(function(index){
            $(this).hide();
        });
        $('#id_ajax_loading').show();
        if(action == 'commit') {
            load_commit_meta();
        } else if(action == 'diff') {
            load_diff_meta();
        }
    });
    function compare() {
        var source_refs = $('#id_source_refs option:selected').val();
        var desc_refs  = $('#id_desc_refs option:selected').val();
        if(source_refs === undefined || desc_refs === undefined) {
            return;
        }
        $('#id_pull_div').hide();
        load_commit_meta();
    }
    function fullfill_options(repo_select, refs_select, default_refs) {
        var repo = repo_select.attr('value');
        var tmp_global_repo_branch_map = global_repo_branch_map;
        if(tmp_global_repo_branch_map.hasOwnProperty(repo)) {
            refs_select.find('option').remove();
            var branches = tmp_global_repo_branch_map[repo];
            for(x in branches) {
                var branch = branches[x];
                if(branch == default_refs) {
                    refs_select.append('<option selected="selected" value='+ branch +'>'+ branch +'</option>');
                } else {
                    refs_select.append('<option value='+ branch +'>'+ branch +'</option>');
                }
            }
            return tmp_global_repo_branch_map[repo];
        }
        $.post('/' + repo + '/refs/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            refs_select.find('option').remove();
            var branches = json.refs_meta.branches;
            for(x in branches) {
                var branch = branches[x];
                if(branch == default_refs) {
                    refs_select.append('<option selected="selected" value='+ branch +'>'+ branch +'</option>');
                } else {
                    refs_select.append('<option value='+ branch +'>'+ branch +'</option>');
                }
            }
            tmp_global_repo_branch_map[repo] = branches;
            compare();
        });
        global_repo_branch_map = tmp_global_repo_branch_map;
    };
    fullfill_options($('#id_source_repo'), $('#id_source_refs'), '{{source_refs}}');
    fullfill_options($('#id_desc_repo'), $('#id_desc_refs'), '{{desc_refs}}');
    $('#id_source_repo').change(function(){
        fullfill_options($(this), $('#id_source_refs'));
    });
    $('#id_desc_repo').change(function(){
        fullfill_options($(this), $('#id_desc_refs'));
    });
    $('#id_source_refs').change(function(){
        compare();
    });
    $('#id_desc_refs').change(function(){
        compare();
    });
    $('#id_pull_form').submit(function() {
        if($('#id_title').val() == '' || $('#id_source_repo option:selected').val() == '' || $('#id_source_refs option:selected').val() == '' || $('#id_desc_repo option:selected').val() == '' || $('#id_desc_refs option:selected').val() == '') {
            $('#id_alert').show();
            return false;
        }
        $('#id_source_repo_select').val($('#id_source_repo option:selected').val());
        $('#id_source_refs_select').val($('#id_source_refs option:selected').val());
        $('#id_desc_repo_select').val($('#id_desc_repo option:selected').val());
        $('#id_desc_refs_select').val($('#id_desc_refs option:selected').val());
        return true;
    });
});
</script>
{% endblock %}
