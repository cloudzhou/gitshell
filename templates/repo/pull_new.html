{% extends "repo/repo.html" %}

{% block subcontainer %}
<div class="repo-main">

	<header class="repo-meta">
		<ul class="breadcrumb">
			<li><a href="/{{user_name}}/{{repo_name}}/pulls/">{{repo_name}}</a><span class="divider">/</span></li>
			<li class="active">创建一个合并请求</li>
    </ul>
	</header>

	<section class="repo-content">
			<div class="pull-request-form clearfix">

				<section class="repo-refs span form-horizontal">
					<div class="control-group">
						<label class="control-label">仓库:</label>
						<div class="controls">
							<select id="id_source_repo" class="select2">
								{% for repo in pull_repo_list %}
									{% if repo.username == source_repo.username and repo.name == source_repo.name %}
										<option selected="selected" value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
									{% else %}
										<option value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
									{% endif %}
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="control-group">
						<label class="control-label">分支:</label>
						<div class="controls">
							<select id="id_source_refs" class="select2">
								<option value="master">master</option>
							</select>
						</div>
					</div>

				</section>

				<section class="repo-refs span form-horizontal">
					<div class="control-group">
						<label class="control-label">仓库:</label>
						<div class="controls">
							<select id="id_desc_repo" class="select2">
								{% for repo in pull_repo_list %}
									{% if repo.username == desc_repo.username and repo.name == desc_repo.name %}
										<option selected="selected" value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
									{% else %}
										<option value="{{repo.username}}/{{repo.name}}">{{repo.username}}/{{repo.name}}</option>
									{% endif %}
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="control-group">
						<label class="control-label">分支:</label>
						<div class="controls">
							<select id="id_desc_refs" class="select2">
								<option value="master">master</option>
							</select>
						</div>
					</div>
				</section>

			</div>

			<div class="clearfix">
				<form id="id_pull_form" method="post" action="" class="form-horizontal">
					<div class="hidden"><input id="id_source_repo_select" type="hidden" value="" name="source_repo"></div>
					<div class="hidden"><input id="id_source_refs_select" type="hidden" value="" name="source_refs"></div>
					<div class="hidden"><input id="id_desc_repo_select" type="hidden" value="" name="desc_repo"></div>
					<div class="hidden"><input id="id_desc_refs_select" type="hidden" value="" name="desc_refs"></div>
						<div class="control-group">
							<label class="control-label" for="id_title">* 标题</label>
							<div class="controls">
								<input id="id_title" name="title" style="width: 500px;" type="text" maxlength="64" placeholder="输入标题，说明此次Pull Request的主要更改。">
							</div>
						</div>
						<div class="control-group">
							<label class="control-label" for="id_desc">描述</label>
							<div class="controls">
								<textarea id="id_desc" name="desc" style="height: 200px; width: 500px;" rows="10" cols="40" maxlength="2048"></textarea>
							</div>
						</div>
						<div class="control-group">
							<div id="id_alert" class="alert hide controls">
								<a class="close" data-dismiss="alert">×</a>
								<span>* 请输入标题，选择来源仓库、分支和目标仓库、分支</span>
							</div>
						</div>
						<div class="control-group">
							<div id="id_submit" class="controls">
								<a class="muted" data-original-title=" 出于礼貌，提前合并目标分支代码，减少对方合并时出现冲突的可能性" rel="tooltip" href="javascript: void(0)"><button type="submit" class="btn btn-success" id="id_pull_submit">创建合并请求</button></a>
							</div>
						</div>
					<div class="hidden"><input type="hidden" value="{{ csrf_token }}" name="csrfmiddlewaretoken"></div>
				</form>
			</div>

    </section>

</div>		  
{% endblock %}

{% block subjs %}
	<script src='/static/js/app/syntaxhighlighter/shCore.js' type='text/javascript'></script>
	<script src='/static/js/app/syntaxhighlighter/shAutoloader.js' type='text/javascript'></script>
	<script src='/static/js/app/syntaxhighlighter/shBrushDiff.js' type='text/javascript'></script>
	<script>
	$(function(){
			var global_repo_branch_map = {};
			$('.c_unixtime').each(function(index){ 
					$(this).html(moment(new Date($(this).html()*1000)).fromNow());
					$(this).show();
			});
			$('#id_submit').tooltip({
				selector: "a[rel=tooltip]"
			});
			function fullfill_options(repo_select, refs_select) {
					var repo = repo_select.attr('value');
					var tmp_global_repo_branch_map = global_repo_branch_map;
					if(tmp_global_repo_branch_map.hasOwnProperty(repo)) {
							refs_select.find('option').remove();
							var branches = tmp_global_repo_branch_map[repo];
							for(x in branches) {
									var branch = branches[x];
									refs_select.append('<option value='+ branch +'>'+ branch +'</option>');
							}
							return tmp_global_repo_branch_map[repo];
					}
					$.ajax({
							url: '/ajax/repo/' + repo + '/refs/',
							type: 'POST',
							data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
							dataType: 'json',
							timeout: 10000,
							error: function(){
							},
							success: function(json){
									refs_select.find('option').remove();
									var branches = json.branches;
									for(x in branches) {
											var branch = branches[x];
											refs_select.append('<option value='+ branch +'>'+ branch +'</option>');
									}
									tmp_global_repo_branch_map[repo] = branches;
							},
					});
					global_repo_branch_map = tmp_global_repo_branch_map;
			};
			fullfill_options($('#id_source_repo'), $('#id_source_refs'));
			fullfill_options($('#id_desc_repo'), $('#id_desc_refs'));
			$('#id_source_repo').change(function(){
					fullfill_options($(this), $('#id_source_refs'));
			});
			$('#id_desc_repo').change(function(){
					fullfill_options($(this), $('#id_desc_refs'));
			});
			$('#id_pull_form').submit(function() {
					if($('#id_title').val() == '' || $('#id_source_repo option:selected').val() == '' || $('#id_source_refs option:selected').val() == '' || $('#id_desc_repo option:selected').val() == '' || $('#id_desc_refs option:selected').val() == '') {
							$('#id_alert').show();
							return false;
					}
					$('#id_source_repo_select').val($('#id_source_repo option:selected').val());
					$('#id_source_refs_select').val($('#id_source_refs option:selected').val());
					$('#id_desc_repo_select').val($('#id_desc_repo option:selected').val());
					$('#id_desc_refs_select').val($('#id_desc_refs option:selected').val());
					return true;
			});

			$('.select2').select2();

	});
	</script>
{% endblock %}
