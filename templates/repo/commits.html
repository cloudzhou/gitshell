{% extends "repo/repo.html" %}

{% block css %}
	<link href="/static/css/app/highlight/github.css" rel="stylesheet">
{% endblock %}

{% block bubble_inner_class_name %} commits{% endblock %}

{% block subcontainer %}

		{% for commit_attrs in commits %}
			<div class="commit colspan">
				<div class="commiter user-plugin span">
					<figure class="avatar"><img src="https://gravatar.com/avatar/{{ gsuserprofile.imgurl }}?s=30" alt="{{ gsuser.username }}"></figure>
					<div class="info">
						<p class="msg"><a href="#">{{ commit_attrs.commit_message|truncatechars:80 }}</a></p>
						<p class="meta"><a href="/{{ commit_attrs.author }}/">{{ commit_attrs.author }}</a> <span class="date unixtime">{{ commit_attrs.committer_date }}</span></p>
					</div>
				</div>
				<span class="hash span"><a href="#" class="btn label-mini btn-info">{{ commit_attrs.commit_hash }}</a></span>
			</div>
		{% endfor %}

		{% if not commits %}
			<div class="commit">
				<p class="info"><img src="/static/img/icons/alert-triangle-yellow.png" alt="">没有提交信息，或者没有查看提交信息权限，<em>半公开和私有项目需要申请成为成员才能查看提交信息</em></p>
			</div>
		{% endif %}

		<footer class="footer">
			<nav class="pagination">
				<p class="nav">
					<a href="#"><img src="/static/img/icons/pagination-previous.png" alt="">上一页</a>
					<a href="#">1</a>
					<a href="#">2</a>
					<a href="#">3</a>
					<a href="#">4</a>
					<a href="#">5</a>
					<a href="#">6</a>
					<a href="#">7</a>
					<a href="#">8</a>
					<a href="#">下一页<img src="/static/img/icons/pagination-next.png" alt=""></a>
				</p>
			</nav>
		</footer>

{% endblock %}

{% block subjs %}
	<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
	<script>
	$(function(){
			set_path_href = function() {
					var base_href_path = '/{{user_name}}/{{repo_name}}/commits/{{refs}}/';
					var path = '{{path}}';
					if(path == '.') {
							return;
					}
					var paths = path.split('/');
					path_href_html = '';
					for(x in paths) {
							subpath = paths[x];
							if(subpath == '') {
									break;
							}
							base_href_path = (base_href_path + subpath + '/');
							if(path.substr(-1) === "/") {
									if(x != (paths.length-2)) {
											path_href_html = (path_href_html + ' <a href="' + base_href_path + '">' + subpath + '</a> /');
									} else {
											path_href_html = (path_href_html + ' ' + subpath + ' /');
									}
							} else {
									if(x != (paths.length-1)) {
											path_href_html = (path_href_html + ' <a href="' + base_href_path + '">' + subpath + '</a> /');
									} else {
											path_href_html = (path_href_html + ' ' + subpath);
									}
							}
					}
					$('#i_repo_path').html(path_href_html);
			};
			set_path_href();
			$('.c_diff_commit').click(function() {
					commit_hash = $(this).attr('value');
					pre_commit_hash = $(this).closest('tr').next().next().find('.c_diff_commit').attr('value')
					if(pre_commit_hash === undefined) {
							return
					}
					label = $('#i_label_' + commit_hash).text()
					if(label == '+') {
							pre_html = $('#i_pre_' + commit_hash).html()
							if(pre_html != '') {
									$('#i_label_' + commit_hash).text('-')
									$('#i_diff_' + commit_hash).show();
									return
							}
							$.ajax({
									url: '/{{user_name}}/{{repo_name}}/diff/' + pre_commit_hash + '/' + commit_hash + '/{{path}}',
									type: 'POST',
									data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
									dataType: 'json',
									timeout: 10000,
									error: function(){
									},
									success: function(json){
											$('#i_pre_' + commit_hash).html('<pre><code class="diff">' + json.diff + '</code></pre>');
											$('pre code').each(function(i, e) { hljs.highlightBlock(e) });
									},
							});
					} else {
					}
			});
	});
	</script>
{% endblock %}
