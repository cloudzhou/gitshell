{% extends "repo/repo.html" %}

{% block bubble_inner_class_name %} issues{% endblock %}

<!--create issue-->
{% block subcontainer %}
	<header class="header">
		<h1 class="heading">Issues</h1>
	</header>
	<div class="btn-group clearfix">
		{%if orderby == 'create_time'%}<a id="i_modify_time" href="javascript:void(0)" class="btn btn-mini first">更新</a>{%else%}<span class="btn btn-mini btn-disable">更新</span>{%endif%}
		{%if orderby == 'modify_time'%}<a id="i_create_time" href="javascript:void(0)" class="btn btn-mini last">创建</a>{%else%}<span class="btn btn-mini btn-disable">创建</span>{%endif%}
	</div>
	{% for issue in issues %}
	<div class="issue colspan">
		<figure class="avatar span">
			<img src="https://gravatar.com/avatar/{{ issue.user_id }}/?s=35" alt="{{issue.user_id}}">
		</figure>
		<div class="data span clearfix">
			<h4 class="heading">
				<span class="issue-id">#{{issue.id}}</span>
				<a href="/{{user_name}}/{{repo_name}}/issues/{{issue.id}}/" class="txt">{{issue.subject|truncatechars:100}}</a>
			</h4>
			{% if user.id == repo.user_id %}
				<a href="javascript: void(0)" rel="tooltip" data-original-title="拖动到上面做属性更改"><i class="icon-ellipsis-vertical"></i></a>
			{% else %}
				<a href="javascript: void(0)" rel="tooltip"><i class="icon-ellipsis-vertical"></i></a>
			{% endif %}
			<span class="unixtime date">{%if orderby == 'modify_time'%}{{issue.modify_time}}{%else%}{{issue.create_time}}{%endif%}</span>
		</div>
	</div>
	{% endfor %}
	{% if not issues %}
		<div class="issue"><p class="info text-warning">没有Issues，或者没有查看Issues权限，半公开和私有项目需要申请成为成员才能查看Issues</p></div>
	{% endif %}

	<footer class="footer">
		<nav class="pagination">
			<ul class="nav">
				<li><a id="i_index_page" href="javascript:void(0)"><i class="icon-home"></i>首页</a></li>
				<li><a id="i_pre_page" href="javascript:void(0)">前一页</a></li>
				<li class="active">第{{page}}页</li>
				<li><a id="i_next_page" href="javascript:void(0)">后一页</a></li>
			</ul>
		</nav>
	</footer>

{% endblock %}

{% block subjs %}
	<script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.21/jquery-ui.min.js"></script>
	<script>
		$(function(){
			var current_attrs = {{current_attrs|safe}};
			$('#i_index_page').click(function(){ 
					current_attrs['page'] = 0;
					location_cons()
			});
			$('#i_pre_page').click(function(){ 
					current_attrs['page'] = current_attrs['page'] - 1;
					location_cons()
			});
			$('#i_next_page').click(function(){ 
					current_attrs['page'] = current_attrs['page'] + 1;
					location_cons()
			});
			$('#i_create_time').click(function(){ 
					current_attrs['orderby'] = 'create_time';
					location_cons()
			});
			$('#i_modify_time').click(function(){ 
					current_attrs['orderby'] = 'modify_time';
					location_cons()
			});
			$('.issues_attr').click(function(){ 
					var keyValue = $(this).attr('value').split("___")
					if(keyValue[0] == 'assigned' && keyValue[1] == '所有') {
							keyValue[1] = '0';
					}
					current_attrs[keyValue[0]] = keyValue[1];
					location_cons()
			});
			location_cons = function() {
					window.location = "/{{user_name}}/{{repo_name}}/issues/list/"+ current_attrs['assigned'] +"/"+ current_attrs['tracker'] +"/"+ current_attrs['status'] +"/"+ current_attrs['priority'] +"/"+ current_attrs['orderby'] +"/"+ current_attrs['page'] +"/";
			}
			$('.c_unixtime').each(function(index){ 
					$(this).html(moment(new Date($(this).html()*1000)).fromNow());
					$(this).show();
			});
			$('.c_issue').tooltip({
				selector: "a[rel=tooltip]"
			})
			$('.c_drag_setting').draggable({
					cursor: 'move',
					revert: true
			});
			$('.issues_attr').droppable({
					accept: '.c_drag_setting',
					hoverClass: 'issues_attr_hovered',
					drop: handleIssueDrop
			});
			function handleIssueDrop(event, ui){
					var issue_id = ui.draggable.attr('value');
					var issue_attr = $(this).attr('value');
					$.ajax({
							url: '/{{user_name}}/{{repo_name}}/issues/update/' + issue_id + '/' + issue_attr + '/',
							type: 'POST',
							data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
							dataType: 'json',
							timeout: 10000,
							error: function(){
							},
							success: function(json){
									location_cons()
							},
					});
			}
		});
	</script>
{% endblock %}
