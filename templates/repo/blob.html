{% extends "repo/repo.html" %}
{% block bubble_inner_class_name %} files{% endblock %}

{% block subcss %}
    <style>
    #i_source_code pre code {
        padding: 18px;
        outline: 3px solid rgba(0, 0, 0, .055);
        background-color: white;
        background-clip: padding-box;
        border: 1px solid #d9d9d9;
        font-family: Courier, Monaco, Consolas, 'Courier New', monospace !important; }
    #i_source_code .container:before, #i_source_code .container:after {
        content: "";
        display: none;
    }
    </style>
{% endblock %}
{% block subcontainer %}
<div class="file-list">
    <header class="header clearfix">
        {% include "repo/branch_nav.html" %}
        <span class="pull-right">
            <a class="btn btn-mini" href="/{{user_name}}/{{repo_name}}/commits/{{refs}}/{{path}}">Commits</a>
            <a class="btn btn-mini" href="/{{user_name}}/{{repo_name}}/raw/blob/{{refs}}/{{path}}">Raw</a>
        </span>
    </header>
    <div id="i_source_code">
        {% if not blob and blob != '' %}
            没有源代码、二进制文件，或者没有查看源代码权限，半公开和私有项目需要申请成为成员才能查看源代码
        {% else %}
            {% if is_markdown %}
                <div id="id_markdown_content" class="markdown hide">{{ blob }}</div>
            {% else %}
                <pre><code>{{ blob }}</code></pre>
            {% endif %}
        {% endif %}
    </div>          
</div>
{% endblock %}
{% block subjs %}
{#script src="/static/js/min/syntaxhighlighter.min.js?timestamp={{gitshell.timestamp}}"></script>#}
<script src="/static/js/app/highlight/highlight.min.js?timestamp={{gitshell.timestamp}}"></script>
{% if is_markdown %}
<script src="/static/js/app/markdown/marked.js"></script>
<script src="/static/js/app/caja/html-css-sanitizer-minified.js"></script>
{% endif %}
<script>
$(function(){
    set_path_href = function() {
        var base_href_path = '/{{user_name}}/{{repo_name}}/tree/{{refs}}/';
        var path = '{{path}}';
        if(path == '.') {
            return;
        }
        var paths = path.split('/');
        path_href_html = '';
        for(x in paths) {
            subpath = paths[x];
            if(subpath == '') {
                break;
            }
            base_href_path = (base_href_path + subpath + '/');
            if(path.substr(-1) === "/") {
                if(x != (paths.length-2)) {
                    path_href_html = (path_href_html + ' <a href="' + base_href_path + '">' + subpath + '</a> /');
                } else {
                    path_href_html = (path_href_html + ' ' + subpath + ' /');
                }
            } else {
                if(x != (paths.length-1)) {
                    path_href_html = (path_href_html + ' <a href="' + base_href_path + '">' + subpath + '</a> /');
                } else {
                    path_href_html = (path_href_html + ' ' + subpath);
                }
            }
        }
        $('#repo-path').html(path_href_html);
    };
    set_path_href();
{% if is_markdown %}
    marked.setOptions({ gfm: true, tables: true, breaks: false, pedantic: false, sanitize: false, smartLists: true, smartypants: false, langPrefix: 'lang-' });
    var html = $('#id_markdown_content').html();
    html = $('<div/>').html(html).text();
    var sanitized_html = html_sanitize(marked(html), function(url) { return url; }, function(id) { return id; })
    $('#id_markdown_content').html(sanitized_html);
    $('#id_markdown_content').show();
{% else %}
    hljs.tabReplace = '    ';
    hljs.initHighlightingOnLoad();
    //SyntaxHighlighter.all();
{% endif %}
});
</script>
{% endblock %}
