{% extends "repo/repo.html" %}

{% block subcontainer %}
<div class="bubble issues">

	<div id="id_issues_condition" class="bubble-header issues-header clearfix">{%include "repo/condition.html"%}</div>

    <div class="bubble-inner">

        <div class="c_issue issue">
					<div class="actions">
						<a href="" rel="tooltip" data-original-title="可拖动到上面"><i class="icon-bell"></i></a>
						<a id="i_issue_edit" href="/{{user_name}}/{{repo_name}}/issues/create/{{issue.id}}/">修改</a>
					</div>
					<h3 id="i_issue_subject"><span class="label">#{{issue.id}}</span>{{issue.subject}}</h3>
					<blockquote>{{issue.content}}</blockquote>
					<p class="meta">
						创建:<a href="/{{issue.user_id}}/">{{issue.user_id}}</a>
						指派:<a href="/{{issue.assigned}}/">{{issue.assigned}}</a>
						<span class="">{{issue.tracker}}</span>
						<span class="">{{issue.status}}</span>
						<span class="">{{issue.priority}}</span>
						<span class="">{{issue.category}}</span>
						<span class="unixtime">{{issue.modify_time}}</span>
					</p>
        </div>


        {%if issue_comments%}
					<ul id="i_issue_comments" class="list">
						{%for issue_comment in issue_comments%}
							<li data-user-name="{{issue_comment.user_id}}" class="c_td_comment">
								<figure class="avatar">
									<img src="https://gravatar.com/avatar/{{ issue_comment.user_img }}?s=32" alt="{{issue.comment}}">
								</figure>
								<div class="issue-body">
									<a class="c_rm_comment" value="{{issue_comment.id}}" href="javascript:void(0)"><i class="icon-close"></i></a>
									<button value="{{issue_comment.id}}" class="c_rm_rf_comment btn btn-mini btn-primary">确定删除该评论？</button>
									<p class="meta"><a href="/{{issue_comment.user_id}}/">{{issue_comment.user_id}}</a><span class="unixtime">{{issue_comment.create_time}}</span><a class="c_ref_comment" href="javascript:void(0)" value="{{issue_comment.user_id}}">回复</a></p>
									<blockquote>{{issue_comment.content}}</blockquote>
								</div>
							</li>
						{%endfor%}
					</ul>
        {%endif%}

        {%if total_page|length > 1%}
					<div class="pagination">
						<ul>
							{%for i in total_page%}
								{%if i == page%}
									<li class="active"><a href="/{{user_name}}/{{repo_name}}/issues/{{issue.id}}/{{i}}/">{{i}}</a></li>
								{%else%}
									<li><a href="/{{user_name}}/{{repo_name}}/issues/{{issue.id}}/{{i}}/">{{i}}</a></li>
								{%endif%}
							{%endfor%}
						</ul>
					</div>
        {%endif%}

        <form id="i_comment" class="form-inline" action="" method="post">
					{% csrf_token %}
					<div id="i_comment_content">{{repoIssuesCommentForm.content}}</div>
					<button id="i_submit" class="btn" type="submit">发表评论</button>
					<small class="muted">不可修改，严谨发言</small>
        </form>
    </div>
	</div>
{% endblock %}

{% block subjs %}
<!--script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js"></script-->
<script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.21/jquery-ui.min.js"></script>
<!--script src="http://lib.sinaapp.com/js/jquery-ui/1.8.11/jquery-ui.min.js"></script-->
<script>
$(function(){
    {% if has_issues_modify_right %}
    $('#i_issue_subject').live('mouseover mouseout', function(event) {
        if (event.type == 'mouseover') {
            $('#i_issue_edit').show();
        } else {
            $('#i_issue_edit').hide();
        }
    });
    {% endif %}
    $('.c_td_comment').live('mouseover mouseout', function(event) {
        if (event.type == 'mouseover') {
            var issues_user_name = $(this).attr('data-user-name');
            if('{{user.username}}' == '{{user_name}}' || issues_user_name == '{{user.username}}') {
                $(this).find('.c_rm_comment').show();
            }
        } else {
            $(this).find('.c_rm_comment').hide();
        }
    });
    $('.c_drag_setting').mouseover(function() {
        $('.c_create_issues_btn').hide();
        $('#id_issues_condition').show();
    });
    $('.c_rm_rf_comment').click(function(){
        var comment_id = $(this).attr('value');
        $.ajax({
            url: '/{{user_name}}/{{repo_name}}/issues/comment/delete/' + comment_id + '/',
            type: 'POST',
            data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
            },
            success: function(json){
                window.location = '/{{user_name}}/{{repo_name}}/issues/{{issue.id}}/{{page}}/'
            },
        });
    });
    $('.c_rm_rf_comment').blur(function(){
        setTimeout(
            function(event) {
                $(this).hide();
            }
        , 300);
    });
    $('.c_rm_comment').click(function(){
        $(this).next().show();
        $(this).next().focus();
    });
    $('#i_submit').mouseover(function(){
        $('#i_comment_content').show();
        $('#id_content').focus();
    });
    $('#i_submit').click(function(){
        if($('#id_content').val() != '') {
            $(this).submit();
            return true;
        }
        return false;
    });
    $('.c_ref_comment').click(function(){
        var ref_username = $(this).attr('value');
        $('#id_content').val($('#id_content').val() + ' @' + ref_username + ' ');
        $('#i_comment_content').show();
        $('#id_content').focus();
        var val = $('#id_content').val();
        $('#id_content').val('')
        $('#id_content').val(val)
    });
    $('.c_unixtime').each(function(index){ 
        $(this).html(moment(new Date($(this).html()*1000)).fromNow());
        $(this).show();
    });
    $('.c_issue').tooltip({
      selector: "a[rel=tooltip]"
    })
    $('.c_drag_setting').draggable({
        cursor: 'move',
        revert: true
    });
    $('.issues_attr').droppable({
        accept: '.c_drag_setting',
        hoverClass: 'issues_attr_hovered',
        drop: handleIssueDrop,
    });
    function handleIssueDrop(event, ui){
        var issue_id = ui.draggable.attr('value');
        var issue_attr = $(this).attr('value');
        $.ajax({
            url: '/{{user_name}}/{{repo_name}}/issues/update/' + {{issue.id}} + '/' + issue_attr + '/',
            type: 'POST',
            data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
            },
            success: function(json){
                window.location = '/{{user_name}}/{{repo_name}}/issues/{{issue.id}}/{{page}}/'
            },
        });
    }
});
</script>
{% endblock %}
