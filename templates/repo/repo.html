{% extends "base.html" %}

{% block css %}
	{% if current == 'index' or current == 'tree' or current == 'commits' %}
		<link href='/static/css/app/syntaxhighlighter/shCore.css' rel='stylesheet'>
		<link href='/static/css/app/syntaxhighlighter/shThemeDefault.css' rel='stylesheet'>
	{% endif %}
{% endblock %}

{% block container_class_name %} bubble bubble-flat repo{% endblock %}


{% block container %}

	<header class="header">
		<div class="repo-actions-bar">
			<ul class="repocrumb breadcrumb">
				<li class="user"><a href="/{{ user_name }}/">{{ user_name }}</a><span class="divider">/</span></li>
				<li><a href="/{{ user_name }}/{{ repo_name }}/">{{ repo_name }}</a><sup><i class="icon-dropbox"></i></sup></li>
			</ul>
			<ul class="repo-actions">
				<li><a href="#" class="btn btn-mini btn-primary"><i class="icon-random"></i>Compare</a>
				<li class="btn-group">
					<a class="btn btn-mini fork first" data-original-title="衍生作为本地仓库" rel="tooltip" href="javascript: void(0)">Pull Request</a>
					<span class="btn btn-mini count last" title="衍生次数" href="/{{ user_name }}/{{ repo_name }}/clone_watch/">{{repo.fork}}</span>
				</li>
				<li><a href="#" class="btn btn-mini">Star</a>
				<li class="btn-group">
					{% if not is_watched_repo %}
						<a class="btn btn-mini watch first" data-original-title="Watch" rel="tooltip" href="javascript: void(0)">Watch</a>
					{% else %}
						<a class="btn btn-mini unwatch first" data-original-title="Unwatch" rel="tooltip" href="javascript: void(0)">Unwatch</a>
					{% endif %}
					<span class="btn btn-mini count last" title="关注次数" href="/{{ user_name }}/{{ repo_name }}/clone_watch/">{{repo.watch}}</span>
				</li>
			</ul>
		</div>
	</header>

	<section class="colspan">
		<nav class="sidenav">
			<ul class="nav nav-list">
				<li class="first{% if current == 'index' or current == 'tree' %} active{% endif %}"><a href="/{{ user_name }}/{{ repo_name }}/tree/" data-original-title="Code" rel="tooltip"><span><i class="icon-code"></i></span></a></li>
				<li class="middle{% if current == 'issues' %} active{% endif %}"><a href="/{{ user_name }}/{{ repo_name }}/issues/" data-original-title="Issues" rel="tooltip"><span><i class="icon-bug"></i></span></a></li>
				<li class="middle{% if current == 'pulls' %} active{% endif %}"><a href="/{{ user_name }}/{{ repo_name }}/pulls/" data-original-title="Pull Request" rel="tooltip"><span><i class="icon-code-fork"></i></span></a></li>
				<li class="middle"><a href="#" data-original-title="Overview" rel="tooltip"><span><i class="icon-desktop"></i></span></a></li>
				<li class="middle"><a href="#" data-original-title="Graph" rel="tooltip"><span><i class="icon-th"></i></span></a></li>
				<li class="last{% if current == 'edit' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/edit/" data-original-title="Setting" rel="tooltip"><span><i class="icon-wrench"></i></span></a></li>
			</ul>
		</nav>

		<section class="bubble-inner{% block bubble_inner_class_name %}{% endblock %}">

			{% block cloneurl %}{% endblock %}

			{% if current == 'index' or current == 'tree' or current == 'commits' %}
				<nav class="repo-tabs nav nav-tabs">
					<ul class="nav clearfix">
						<li class="first{% if current == 'index' or current == 'tree' %} active{% endif %}"><a href="/{{ user_name }}/{{ repo_name }}/tree/">Code</a></li>
						<li {% if current == 'commits' %} class="active" {% endif %}><a href="/{{ user_name }}/{{ repo_name }}/commits/{{ refs }}/">Commit<span class="label label-mini{% if current == 'commits' %} label-success{% endif %}">58</span></a></li>
						<li><a href="#">Branch<span class="label label-mini">4</span></a></li>
						<li><a href="#">Tag<span class="label label-mini">2</span></a></li>
						<li class="last"><a href="#">Graph</a></li>
					</ul>
				</nav>
			{% endif %}

			{% block bubbleheader %}{% endblock %}

			<section class="inner-container">
				{% block subcontainer %}{% endblock %}
			</section>

		</section>

	</section>

{% endblock %}




{% block js %}
<script>
	$(function(){
		$('#toggle-arrow').click(
			function(){
				$(this).next('.url').slideToggle('fast');
			}
		);
		$('#url').click(
			function(){
				$(this).toggleClass('active');
			}
		);
		$('.sidenav a.btn').tooltip();
	});
</script>
<script src="/static/js/moment.min.js"></script>
<script src="/static/js/moment.zh-cn.js"></script>
<script>
/*global jQuery, window */
$(function(){
    moment.lang('zh-cn');

    $('.branches .dropdown-toggle').click(function(event) {
        $('#i_git_url').select();
    });

    var current_refs = '{{ refs }}';
    if(current_refs == '') {
        current_refs = 'master';
    }
    var do_refs = function() {
        is_refs_mouseover = true;
        $.ajax({
            url: '/{{user_name}}/{{repo_name}}/refs/',
            type: 'POST',
            data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
                //alert('');
            },
            success: function(json){
                if($('.branches .dropdown-menu li').size() > 0) {
                    return;
                }
                for(x in json.branches) {
                    var current = ' ';
                    if(json.branches[x] == current_refs) {
                        current = '✓';
                        $('#id_branch_or_tag').text('分支：');
                    }
                    for(x in json.branches) {
                        var current = ' ';
                        if(json.branches[x] == current_refs) {
                            current = '✓';
                            $('#id_branch_or_tag').text('分支：');
                        }
                        $('.branches .dropdown-menu').append('<li><a href="/{{user_name}}/{{repo_name}}/tree/' + json.branches[x] + '/">' + current + json.branches[x] + '</a></li>');
                    } 
                    if(json.tags.length > 0) {
                        $('.branches .dropdown-menu').append('<li class="divider"></li>');
                    }
                    for(x in json.tags) {
                        va current = ' ';
                        if(json.tags[x] == current_refs) {
                            current = '✓';
                            $('#id_branch_or_tag').text('标签：');
                        }
                        $('.branches .dropdown-menu').append('<li><a href="/{{user_name}}/{{repo_name}}/tree/' + json.tags[x] + '/">' + current + json.tags[x] + '</a></li>');
                    } 
                },
            })
        }
        var disabled_watch = false;
        var disabled_fork = false;
        $('.watch').click(function() {
            if(disabled_watch) {
                return false;
            }
            disabled_watch = true;
            $.ajax({
                url: '/{{user_name}}/{{repo_name}}/watch/',
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                dataType: 'json',
                timeout: 10000,
                error: function(){
                    disabled_watch = false;
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html('网络原因，请求失败，请刷新再次尝试');
                },
                success: function(json){
                    if(json.result == 'success') {
                        window.location = window.location
                        return true;
                    }
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html(json.message);
                },
            })
        })
        $('.unwatch').click(function() {
            if(disabled_watch) {
                return false;
            }
            disabled_watch = true;
            $.ajax({
                url: '/{{user_name}}/{{repo_name}}/unwatch/',
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                dataType: 'json',
                timeout: 10000,
                error: function(){
                    disabled_watch = false;
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html('网络原因，请求失败，请刷新再次尝试');
                },
                success: function(json){
                    if(json.result == 'success') {
                        window.location = window.location
                        return true;
                    }
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html(json.message);
                },
            })
        })
    {% if has_fork_right %}
        $('.fork').click(function() {
            if(disabled_fork) {
                return false;
            }
            disabled_fork = true;
            $.ajax({
                url: '/{{user_name}}/{{repo_name}}/fork/',
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                dataType: 'json',
                timeout: 10000,
                error: function(){
                    disabled_fork = false;
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html('网络原因，请求失败，请刷新再次尝试');
                },
                success: function(json){
                    if(json.result == 'success') {
                        window.location = '/{{user.username}}/{{repo_name}}/';
                        return true;
                    }
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html(json.message);
                },
            })
        })
    {% endif %}
        do_refs();
        var is_refs_mouseover = false;
        $('#i_refs').mouseover(function(event) {
            if($('#i_refs .dropdown-menu li').size() == 0 && !is_refs_mouseover) {
                do_refs();
            }
        });
        $('.c_repo_action').tooltip({
            selector: "a[rel=tooltip]"
        });
        $('#id_ssh_fork').mouseover(function(event) {
            $('#id_git_url').html('<input class="input-xlarge focused" value="git@gitshell.com:{{ user_name }}/{{ repo_name }}.git"/>');
            $('#id_read_write').html('读写');
        });
        $('#id_http_fork').mouseover(function(event) {
            $('#id_git_url').html('<input class="input-xlarge focused" value="https://gitshell.com/{{ user_name }}/{{ repo_name }}.git"/>');
            $('#id_read_write').html('读写');
        });
        $('#id_git_fork').mouseover(function(event) {
            $('#id_git_url').html('<input class="input-xlarge focused" value="git://gitshell.com/{{ user_name }}/{{ repo_name }}.git"/>');
            $('#id_read_write').html('只读');
        });
    {% if is_owner %}
        $('#id_repo_desc').live('mouseover mouseout', function(event) {
            if (event.type == 'mouseover') {
                $('#id_manage_repo').show();
            } else {
                $('#id_manage_repo').hide();
            }
        });
    {% endif %}

			$('.repo-admin-edit').hide();
			$('.repo-summary > .description').hover(
				function(){
					$('.repo-admin-edit').show();
				},function(){
					$('.repo-admin-edit').hide();
				}
			);

    });
    </script>
    {% block subjs %}{% endblock %}
{% endblock %}
