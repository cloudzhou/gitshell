{% extends "base.html" %}

{% block css %}
    {% if current == 'blob' %}
        <link href='/static/css/app/syntaxhighlighter/shCore.css' rel='stylesheet'>
        <link href='/static/css/app/syntaxhighlighter/shThemeDefault.css' rel='stylesheet'>
    {% endif %}
{% endblock %}

{% block container_class_name %} bubble bubble-flat repo{% endblock %}

{% block container %}
    <header class="header">
        <div class="repo-actions-bar">
            <ul class="repocrumb breadcrumb">
                <li class="user"><a href="/{{user_name}}/">{{user_name}}</a><span class="divider">/</span></li>
                <li>
                    <a href="/{{user_name}}/{{repo_name}}/">{{repo_name}}</a>
                    <sup class="{%if repo.dropbox_sync == 1%}synced{%endif%}"><a href="/{{user_name}}/{{repo_name}}/settings/#dropbox"><i class="icon-dropbox"></i></a></sup>
                </li>
            </ul>
            <ul class="repo-actions">
                <li><a href="/{{user_name}}/{{repo_name}}/compare/" class="btn btn-mini btn-primary"><i class="icon-random"></i>Compare</a>
                <li><a href="/{{user_name}}/{{repo_name}}/pull/new/" class="btn btn-mini"><i class="icon-code-fork"></i>Pull Request</a>
                <li class="btn-group">
                    {% if is_watched_repo %}
                        <a class="btn btn-mini unwatch" data-original-title="Unwatch" rel="tooltip" href="javascript: void(0)">Unwatch</a>
                    {% else %}
                        <a class="btn btn-mini watch" data-original-title="Watch" rel="tooltip" href="javascript: void(0)">Watch</a>
                    {% endif %}
                </li>
                <li class="btn-group">
                    {% if is_stared_repo %}
                        <a class="btn btn-mini unstar first" data-original-title="Unstar" rel="tooltip" href="javascript: void(0)">Unstar</a>
                    {% else %}
                        <a class="btn btn-mini star first" data-original-title="Star" rel="tooltip" href="javascript: void(0)">Star</a>
                    {% endif %}
                    <span class="btn btn-mini count last" title="标星次数" href="/{{user_name}}/{{repo_name}}/clone_watch_star/">{{repo.star}}</span>
                </li>
                <li class="btn-group">
                  {% if has_fork_right %}
                        <a class="btn btn-mini fork first" data-original-title="Fork" rel="tooltip" href="javascript: void(0)">Fork</a>
                        <span class="btn btn-mini count last" title="衍生次数" href="/{{user_name}}/{{repo_name}}/clone_watch_star/">{{repo.fork}}</span>
                    {% endif %}
                </li>
            </ul>
        </div>
    </header>

    <section class="colspan">
        <nav class="sidenav">
            <ul class="nav nav-list">
                <li class="first{% if current == 'index' or current == 'tree' or current == 'blob' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/" data-original-title="Code" rel="tooltip"><span><i class="icon-code"></i></span></a></li>
                <li class="middle{% if current == 'issues' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/issues/" data-original-title="Issues" rel="tooltip"><span><i class="icon-bug"></i></span></a></li>
                <li class="middle{% if current == 'compare' or current == 'pull' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/pulls/" data-original-title="Pull Request" rel="tooltip"><span><i class="icon-code-fork"></i></span></a></li>
                <!--TODO design overview page-->
                <li class="middle{% if current == 'pulse' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/pulse/" data-original-title="Overview" rel="tooltip"><span><i class="icon-desktop"></i></span></a></li>
                <!--TODO if is_owner, last or middle ? -->
                <li class="middle{% if current == 'stats' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/stats/" data-original-title="Graph" rel="tooltip"><span><i class="icon-th"></i></span></a></li>
                {% if is_owner %}
                <li class="last{% if current == 'settings' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/settings/" data-original-title="Setting" rel="tooltip"><span><i class="icon-wrench"></i></span></a></li>
                {% endif %}
            </ul>
        </nav>

        <section class="bubble-inner{% block bubble_inner_class_name %}{% endblock %}">

            {% if current == 'index' %}
            <div class="description well">
                <p>{{repo.desc|truncatechars:80}} <a href="#README.md">Read More</a></p>
            </div>
    
            <div class="url-container clearfix visible">
                {% if repo.status != 0 %}
                    <p class="info">仓库正在初始化中...暂时不能提交、查看源代码，请耐心等候，稍后刷新。（这种情况很可能是初始化一个较大的仓库）</p>
                {% endif %}
                {% if has_fork_right %}
                    <dl class="url colspan">
                        <dt class="btn-group span">
                            {% if is_repo_member %}
                                <a id="ssh_fork" class="url-select btn first">SSH</a></span>
                            {% endif %}
                                <a id="http_fork" class="active url-select btn middle">HTTP</a></span>
                            {% if repo.auth_type == 0 %}
                                <a id="git_fork" class="url-select btn middle">GIT</a></span>
                            {% endif %}
                        </dt>
                        <dd class="url-holder btn-group span" style="position: relative;">
                            <!--as input and click then select all-->
                            {% if is_repo_member %}
                              <span class="btn middle" id="url-data"><span class="url-git">git</span>@<span class="url-gitshell">gitshell.com</span>:<span class="url-username">{{user_name}}</span>/<span class="url-repo-name">{{repo_name}}</span>.git</span>
                            {% elif repo.auth_type == 0 %}
                              <span class="url-data btn middle"><span class="url-git">https://</span><span class="url-gitshell">{{user_name}}@gitshell.com</span>/<span class="url-username">{{user_name}}</span>/<span class="url-repo-name">{{repo_name}}</span>.git</span>
                            {% endif %}
                            <!--TODO clipboard jsipboard, try to using button? -->
                              <a href="#" class="clipboard url-select btn last" id="url-js-copy"><i class="icon-copy"></i>复制</a>
                            <span class="span" id="url-info">{% if is_repo_member %}读写{% elif repo.auth_type == 0 %}只读{% endif %}</span>
                        </dd>
                    </dl>
                {% endif %}
            </div>
            {% endif %}

            {% if current == 'index' or current == 'tree' or current == 'blob' or current == 'commits' or current == 'branches' or current == 'tags' or current == 'refs_graph' %}
                <nav class="repo-tabs nav nav-tabs">
                    <ul class="nav clearfix">
                        <li class="first{% if current == 'index' or current == 'tree' or current == 'blob' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/tree/{{refs}}/">Code</a></li>
                        <li {% if current == 'commits' %} class="active" {% endif %}><a href="/{{user_name}}/{{repo_name}}/commits/{{refs}}/">Commit<span class="label label-mini{% if current == 'commits' %} label-success{% endif %}">{{repo.commit}}</span></a></li>
                        <li {% if current == 'branches' %} class="active" {% endif %}><a href="/{{user_name}}/{{repo_name}}/branches/{{refs}}/">Branch<span class="label label-mini{% if current == 'branches' %} label-success{% endif %}">{{refs_meta.branch_count}}</span></a></li>
                        <li {% if current == 'tags' %} class="active" {% endif %}><a href="/{{user_name}}/{{repo_name}}/tags/{{refs}}/">Tag<span class="label label-mini{% if current == 'tags' %} label-success{% endif %}">{{refs_meta.tag_count}}</span></a></li>
                        <li class="last{% if current == 'refs_graph' %} active{% endif %}"><a href="/{{user_name}}/{{repo_name}}/refs/graph/{{refs}}/">Graph</a></li>
                    </ul>
                </nav>
            {% endif %}

            {% block bubbleheader %}{% endblock %}

            <section class="inner-container">
                {% block subcontainer %}{% endblock %}
            </section>

        </section>

    </section>

{% endblock %}

{% block js %}
<script src="/static/js/zclip.min.js"></script>
<script>
$(function(){

    $("#ssh_fork, #http_fork, #git_fork").bind({
      click: function(e) {
        e.preventDefault();
        $(this).addClass("active").siblings().removeClass("active");
        switch(this.id) {
          case "ssh_fork":
            $('#url-data').html('<span class="url-git">git</span>@<span class="url-gitshell">gitshell.com</span>:<span class="url-username">{{user_name}}</span>/<span class="repo-name">{{repo_name}}</span>.git');
            $('#url-info').html('读写');
            break;
          case "http_fork":
            $('#url-data').html('<span class="url-http">https</span>://<span class="url-gitshell">gitshell.com</span>/<span class="url-username">{{user_name}}/<span class="url-reponame">{{repo_name}}</span>.git');
            $('#url-info').html('读写');
            break;
          case "git_fork":
            $('#url-data').html('<span class="url-git">git</span>://<span class="url-gitshell">gitshell.com</span>/{{user_name}}</span>/<span class="url-reponame">{{repo_name}}</span>.git');
            $('#url-info').html('只读');
            break;
        };
      }
    });

    $("#url-js-copy").zclip({
      path: "/static/js/ZeroClipboard.swf",
      copy: function() { return $("#url-data").html(); }
    });

    $('.repo-actions-bar .watch').click(function() {
        $.post('/{{user_name}}/{{repo_name}}/watch/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            window.location = window.location;
        });
    });
    $('.repo-actions-bar .unwatch').click(function() {
        $.post('/{{user_name}}/{{repo_name}}/unwatch/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            window.location = window.location;
        });
    });
    $('.repo-actions-bar .star').click(function() {
        $.post('/{{user_name}}/{{repo_name}}/star/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            window.location = window.location;
        });
    });
    $('.repo-actions-bar .unstar').click(function() {
        $.post('/{{user_name}}/{{repo_name}}/unstar/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            window.location = window.location;
        });
    });
    $('.repo-actions-bar .fork').click(function() {
        $.post('/{{user_name}}/{{repo_name}}/fork/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            window.location = '/{{user.username}}/{{repo_name}}/';
        });
    });
    <!--TODO what for? -->
    $('#toggle-arrow').click(
        function(){
            $(this).next('.url').slideToggle('fast');
        }
    );
    $('#url').click(
        function(){
            $(this).toggleClass('active');
        }
    );
    $('.sidenav a.btn').tooltip();
    $('.branches .dropdown-toggle').click(function(event) {
        $('#i_git_url').select();
    });
        $('.c_repo_action').tooltip({
            selector: "a[rel=tooltip]"
        });

    $('.repo-admin-edit').hide();
    $('.repo-summary > .description').hover(
        function(){
            $('.repo-admin-edit').show();
        },function(){
            $('.repo-admin-edit').hide();
        }
    );

});
</script>
{% block subjs %}{% endblock %}
{% endblock %}
