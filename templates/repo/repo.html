{% extends "base.html" %}

{% block css %}
	{% if current == 'index' or current == 'tree' or current == 'commits' %}
		<link href='/static/css/app/syntaxhighlighter/shCore.css' rel='stylesheet'>
		<link href='/static/css/app/syntaxhighlighter/shThemeDefault.css' rel='stylesheet'>
	{% endif %}
{% endblock %}

{% block container %}
<div class="repo-container bubble-flat clearfix">

	<header class="repo-header">
		<div class="repo-actions-bar clearfix">
			<ul class="repocrumb clearfix">
				<li class="user"><a href="/{{ user_name }}/"><i class="icon-meh"></i>{{ user_name }}</a><span class="divider">&rarr;</span></li>
				<li><a href="/{{ user_name }}/{{ repo_name }}/">{{ repo_name }}</a><sup><i class="icon-dropbox"></i></sup></li>
			</ul>
			<ul class="repo-actions btn-group">
				<li><a href="#" class="btn">Star</a>
				<li class="btn-group">
					{% if not is_watched_repo %}
						<a class="btn watch first" data-original-title="Watch" rel="tooltip" href="javascript: void(0)">Watch</a>
					{% else %}
						<a class="btn unwatch first" data-original-title="Unwatch" rel="tooltip" href="javascript: void(0)">Unwatch</a>
					{% endif %}
					<span class="btn count last" title="关注次数" href="/{{ user_name }}/{{ repo_name }}/clone_watch/">{{repo.watch}}</span>
				</li>
				<li class="btn-group">
					<a class="btn fork first" data-original-title="衍生作为本地仓库" rel="tooltip" href="javascript: void(0)">Pull Request</a>
					<span class="btn count last" title="衍生次数" href="/{{ user_name }}/{{ repo_name }}/clone_watch/">{{repo.fork}}</span>
				</li>
				<li><a href="#" class="btn"><i class="icon-random"></i>Compare</a>
			</ul>
		</div>
		<div class="description clearfix">
			<p>{{repo.desc|truncatechars:140}} <a href="#README.md">阅读更多</a></p>
			<p class="repo-admin-edit btn-group">
				<a href="/{{user_name}}/{{repo_name}}/edit/" class="first btn btn-mini"><i class="icon-edit"></i>编辑</a>
				<a href="/{{user_name}}/{{repo_name}}/delete/" class="last btn btn-mini"><i class="icon-trash"></i>删除</a>
			</p>
		</div>
	</header>

	<div class="clearfix">
		<nav class="sidenav">
			<ul class="nav nav-list">
				<li {% if current == 'index' or current == 'tree' %}class="active"{% endif %}><a href="/{{ user_name }}/{{ repo_name }}/tree/"><span><i class="icon-code"></i></span></a></li>
				<li {% if current == 'issues' %}class="active"{% endif %}><a href="/{{ user_name }}/{{ repo_name }}/issues/"><span><i class="icon-bug"></i></span></a></li>
				<li {% if current == 'pulls' %}class="active"{% endif %}><a href="/{{ user_name }}/{{ repo_name }}/pulls/"><span><i class="icon-code-fork"></i></span></a></li>
				<li><a href="#"><span><i class="icon-desktop"></i></span></a></li>
				<li><a href="#"><span><i class="icon-th"></i></span></a></li>
				<li {% if current == 'edit' %}class="active"{% endif %}><a href="/{{user_name}}/{{repo_name}}/edit/"><span><i class="icon-wrench"></i></span></a></li>
			</ul>
		</nav>

		<div class="repo-main">

		{% if current == 'index' or current == 'tree' or current == 'commits' %}
			<div class="repo-clone-url clearfix{% if current == 'index' or current == 'tree' %} visible{%else%} hide{%endif%}">
				<a href="#" id="toggle-arrow"><i class="icon-chevron-down"></i></a>
				{% if repo.status != 0 %}
					<p class="info">仓库正在初始化中...暂时不能提交、查看源代码，请耐心等候，稍后刷新。（这种情况很可能是初始化一个较大的仓库）</p>
				{% endif %}
				{% if has_fork_right %}
					<dl class="clone-url clearfix">
						<dt class="clearfix">
							{% if is_repo_member %}
								<a id="id_ssh_fork" class="url-select first">SSH</a>
							{% endif %}
								<a id="id_http_fork" class="active url-select">HTTP</a>
							{% if repo.auth_type == 0 %}
								<a id="id_git_fork" class="url-select">GIT</a>
							{% endif %}
						</dt>
						<dd class="url-holder clearfix">
							{% if is_repo_member %}
								<span class="url" id="url"><span class="url-git">git</span>@<span class="url-gitshell">gitshell.com</span>:<span class="url-username">{{ user_name }}</span>/<span class="url-repo-name">{{ repo_name }}</span>.git</span>
							{% elif repo.auth_type == 0 %}
								<span class="url"><span class="url-git">https://</span><span class="url-gitshell">gitshell.com</span>/<span class="url-username">{{ user_name }}</span>/<span class="url-repo-name">{{ repo_name }}</span>.git</span>
							{% endif %}
							<span class="clipboard url-select last"><a class="url-js-copy"><i class="icon-copy"></i>复制</a></span>
								<span class="muted url-info">{% if is_repo_member %}读写{% elif repo.auth_type == 0 %}只读{% endif %}</span>
						</dd>
					</dl>
				{% endif %}
			</div>

			<nav class="repo-tabs">
				<ul class="nav clearfix">
					<li class="first{% if current == 'index' or current == 'tree' %} active{% endif %}"><a href="/{{ user_name }}/{{ repo_name }}/tree/"><i class="icon-code"></i>Code</a></li>
					<li {% if current == 'commits' %} class="active" {% endif %}><a href="/{{ user_name }}/{{ repo_name }}/commits/{{ refs }}/"><i class="icon-time"></i>Commit<span class="label label-mini{% if current == 'commits' %} label-success{% endif %}">58</span></a></li>
					<li><a href="#"><i class="icon-code-fork"></i>Branch<span class="label label-mini">4</span></a></li>
					<li><a href="#"><i class="icon-tag"></i>Tag<span class="label label-mini">2</span></a></li>
					<li class="last"><a href="#"><i class="icon-adjust"></i>Graph</a></li>
				</ul>
			</nav>

			{% endif %}
			<section class="repo-body">
				{% block subcontainer %}{% endblock %}
			</section>

		</div>

	</div>

</div>
{% endblock %}




{% block js %}
<script>
	$(function(){
		$('#toggle-arrow').click(
			function(){
				$(this).next('.clone-url').slideToggle('fast');
			}
		);
		$('#url').click(
			function(){
				$(this).toggleClass('active');
			}
		);
	});
</script>
<script src="/static/js/moment.min.js"></script>
<script src="/static/js/moment.zh-cn.js"></script>
<script>
/*global jQuery, window */
$(function(){
    moment.lang('zh-cn');

    $('.branches .dropdown-toggle').click(function(event) {
        $('#i_git_url').select();
    });

    var current_refs = '{{ refs }}';
    if(current_refs == '') {
        current_refs = 'master';
    }
    var do_refs = function() {
        is_refs_mouseover = true;
        $.ajax({
            url: '/{{user_name}}/{{repo_name}}/refs/',
            type: 'POST',
            data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
                //alert('');
            },
            success: function(json){
                if($('.branches .dropdown-menu li').size() > 0) {
                    return;
                }
                for(x in json.branches) {
                    var current = ' ';
                    if(json.branches[x] == current_refs) {
                        current = '✓';
                        $('#id_branch_or_tag').text('分支：');
                    }
                    for(x in json.branches) {
                        var current = ' ';
                        if(json.branches[x] == current_refs) {
                            current = '✓';
                            $('#id_branch_or_tag').text('分支：');
                        }
                        $('.branches .dropdown-menu').append('<li><a href="/{{user_name}}/{{repo_name}}/tree/' + json.branches[x] + '/">' + current + json.branches[x] + '</a></li>');
                    } 
                    if(json.tags.length > 0) {
                        $('.branches .dropdown-menu').append('<li class="divider"></li>');
                    }
                    for(x in json.tags) {
                        va current = ' ';
                        if(json.tags[x] == current_refs) {
                            current = '✓';
                            $('#id_branch_or_tag').text('标签：');
                        }
                        $('.branches .dropdown-menu').append('<li><a href="/{{user_name}}/{{repo_name}}/tree/' + json.tags[x] + '/">' + current + json.tags[x] + '</a></li>');
                    } 
                },
            })
        }
        var disabled_watch = false;
        var disabled_fork = false;
        $('.watch').click(function() {
            if(disabled_watch) {
                return false;
            }
            disabled_watch = true;
            $.ajax({
                url: '/{{user_name}}/{{repo_name}}/watch/',
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                dataType: 'json',
                timeout: 10000,
                error: function(){
                    disabled_watch = false;
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html('网络原因，请求失败，请刷新再次尝试');
                },
                success: function(json){
                    if(json.result == 'success') {
                        window.location = window.location
                        return true;
                    }
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html(json.message);
                },
            })
        })
        $('.unwatch').click(function() {
            if(disabled_watch) {
                return false;
            }
            disabled_watch = true;
            $.ajax({
                url: '/{{user_name}}/{{repo_name}}/unwatch/',
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                dataType: 'json',
                timeout: 10000,
                error: function(){
                    disabled_watch = false;
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html('网络原因，请求失败，请刷新再次尝试');
                },
                success: function(json){
                    if(json.result == 'success') {
                        window.location = window.location
                        return true;
                    }
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html(json.message);
                },
            })
        })
    {% if has_fork_right %}
        $('.fork').click(function() {
            if(disabled_fork) {
                return false;
            }
            disabled_fork = true;
            $.ajax({
                url: '/{{user_name}}/{{repo_name}}/fork/',
                type: 'POST',
                data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
                dataType: 'json',
                timeout: 10000,
                error: function(){
                    disabled_fork = false;
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html('网络原因，请求失败，请刷新再次尝试');
                },
                success: function(json){
                    if(json.result == 'success') {
                        window.location = '/{{user.username}}/{{repo_name}}/';
                        return true;
                    }
                    $('#id_repo_alert').show();
                    $('#id_alert_message').html(json.message);
                },
            })
        })
    {% endif %}
        do_refs();
        var is_refs_mouseover = false;
        $('#i_refs').mouseover(function(event) {
            if($('#i_refs .dropdown-menu li').size() == 0 && !is_refs_mouseover) {
                do_refs();
            }
        });
        $('.c_repo_action').tooltip({
            selector: "a[rel=tooltip]"
        });
        $('#id_ssh_fork').mouseover(function(event) {
            $('#id_git_url').html('<input class="input-xlarge focused" value="git@gitshell.com:{{ user_name }}/{{ repo_name }}.git"/>');
            $('#id_read_write').html('读写');
        });
        $('#id_http_fork').mouseover(function(event) {
            $('#id_git_url').html('<input class="input-xlarge focused" value="https://gitshell.com/{{ user_name }}/{{ repo_name }}.git"/>');
            $('#id_read_write').html('读写');
        });
        $('#id_git_fork').mouseover(function(event) {
            $('#id_git_url').html('<input class="input-xlarge focused" value="git://gitshell.com/{{ user_name }}/{{ repo_name }}.git"/>');
            $('#id_read_write').html('只读');
        });
    {% if is_owner %}
        $('#id_repo_desc').live('mouseover mouseout', function(event) {
            if (event.type == 'mouseover') {
                $('#id_manage_repo').show();
            } else {
                $('#id_manage_repo').hide();
            }
        });
    {% endif %}

			$('.repo-admin-edit').hide();
			$('.repo-summary > .description').hover(
				function(){
					$('.repo-admin-edit').show();
				},function(){
					$('.repo-admin-edit').hide();
				}
			);

    });
    </script>
    {% block subjs %}{% endblock %}
{% endblock %}
