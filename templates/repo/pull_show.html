{% extends "repo/repo.html" %}

{% block css %}
	<link href="/static/css/app/highlight/github.css" rel="stylesheet">
{% endblock %}

{% block bubble_inner_class_name %} pulls{% endblock %}

{% block subcontainer %}
	<header class="header">
		<h1 class="heading">#{{pullRequest.id}} 合并请求</h1>
	</header>

	<div id="id_merge_process" class="well hide">
		<p>merge from {{pullRequest.source_repo.username}}/{{pullRequest.source_repo.name}}:{{pullRequest.source_refname}}to{{pullRequest.desc_repo.username}}/{{pullRequest.desc_repo.name}}:{{pullRequest.desc_refname}}</p>
		<pre id="id_merge_output"></pre>
		<a id="id_merge_after" class="hide" href="/{{user_name}}/{{repo_name}}/pulls/" class="btn">确定</a>
	</div>

	<div id="id_merge_action" class="pull rowspan">

		<div class="row">
			<ul class="horizontal-list pull-branch">
				<li class="first repo-refs"><p>{{pullRequest.source_repo.username}}/{{pullRequest.source_repo.name}}:{{pullRequest.source_refname}}</p></li>
				<li class="last repo-refs"><p>{{pullRequest.desc_repo.username}}/{{pullRequest.desc_repo.name}}:{{pullRequest.desc_refname}}</p></li>
			</ul>
			<div class="data">
				<h2 class="heading">{{pullRequest.title}}</h2>
				<p>{{pullRequest.desc}}</p>
			</div>
			{% if is_owner %}
				<div id="id_merge">
					<a class="muted" data-original-title=" 将尝试合并该请求，进行分支合并" rel="tooltip" href="javascript: void(0)"><button class="btn btn-primary" id="id_pull_merge">开始合并</button></a>
					<a class="muted" data-original-title=" 由于各种原因，你可能不同意此次合并请求，请和发起者做好沟通" rel="tooltip" href="javascript: void(0)"><button class="btn btn-danger" id="id_pull_reject">拒绝</button></a>
					<a class="muted" data-original-title=" 由于各种原因，不再需要此次合并分支，将进行关闭" rel="tooltip" href="javascript: void(0)"><button class="btn btn-inverse" id="id_pull_close">关闭</button></a>
				</div>
			{% endif %}
			<input id="id_pullRequest_id" type="hidden" value="{{pullRequest.id}}" name="pullRequest_id" class="hide">
			<input id="id_pull_action" type="hidden" value="" name="pull_action" class="hide">
			<input type="hidden" value="{{ csrf_token }}" name="csrfmiddlewaretoken" class="hide">
		</div>

		<div class="row">
			<ul class="nav nav-tabs">
				<li class="c_pull_request_action active" data-action="commit"><a href="javascript:void(0)">Commits</a></li>
				<li class="c_pull_request_action" data-action="diff"><a href="javascript:void(0)">Diff</a></li>
			</ul>
			<div id="id_pull_meta_data">
				<figure id="id_ajax_loading" class="c_pull_request_content hide loader"><img src='/static/img/loading.gif' alt="loading"></figure>
				<p id="id_pull_request_commit" class="c_pull_request_content hide alert alert-info"></p>
				<div id="id_pull_request_diff" class="c_pull_request_content hide"></div>
			</div>
		</div>

	</div>

{% endblock %}

{% block subjs %}
<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>
<script>
$(function(){
    var global_repo_branch_map = {};
    $('#id_merge').tooltip({
      selector: "a[rel=tooltip]"
    });
    var load_commit_meta = function() {
        $.post('/{{user_name}}/{{repo_name}}/pull/{{pullRequest.id}}/commit/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            var html = [];
            var is_up_to_date = false;
            var source_commit_hash = json.source_repo_refs_commit_hash.substr(0, 7);
            var desc_commit_hash = json.desc_repo_refs_commit_hash.substr(0, 7);
            var exists_commit_hash_map = {};
            exists_commit_hash_map[desc_commit_hash] = 1
            var up_to_date = 'Already up-to-date. 你并不需要进行合并操作';
            if(json.commits.length > 0) {
                html.push('<table class="table table-striped"><thead class="fixed"><tr><th width="20%">提交HASH (作者)</th><th width="10%">时间</th><th>日志</th></tr></thead><tbody>');
                for(x in json.commits) {
                    var commit_hash = json.commits[x].commit_hash;
                    if(commit_hash in exists_commit_hash_map) {
                        var tmp_parent_commit_hashs = json.commits[x].parent_commit_hash.split(' ')
                        for(y in tmp_parent_commit_hashs) {
                            exists_commit_hash_map[tmp_parent_commit_hashs[y]] = 1;
                        }
                    }
                    var committer = json.commits[x].committer;
                    var committer_date = json.commits[x].committer_date;
                    var committer_moment = moment(new Date(committer_date*1000)).fromNow();
                    var commit_message = json.commits[x].commit_message;
                    html.push('<tr><td><code>' + commit_hash + '</code><span>(' + committer + ')</span></td><td><span style="display: inline;">' + committer_moment + '</span></td><td>' + commit_message + '</td></tr>');
                }
                html.push('</tbody></table>');
            } else {
                html.push(up_to_date);
            }
            if(source_commit_hash in exists_commit_hash_map) {
                is_up_to_date = true;
            }
            $('.c_pull_request_content').each(function(index){
                $(this).hide();
             });
            if(is_up_to_date) {
                $('#id_pull_request_commit').html(up_to_date);
            } else {
                $('#id_pull_request_commit').html(html.join(''));
            }
            $('#id_pull_request_commit').show();
        });
    }
    var load_diff_meta = function() {
        $.post('/{{user_name}}/{{repo_name}}/pull/{{pullRequest.id}}/diff/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            var diff = json.diff;
            $('.c_pull_request_content').each(function(index){
                $(this).hide();
            });
						$('#id_pull_request_diff').html('<pre><code class="diff">' + diff + '</code></pre>');
            //SyntaxHighlighter.highlight();
						$('pre code').each(function(i, e) {hljs.highlightBlock(e)});
            $('#id_pull_request_diff').show();
        });
    }
    $('.c_pull_request_action').click(function(){
        var action = $(this).data('action');
        $('.c_pull_request_action').each(function(index){
            $(this).removeClass('active');
        });
        $(this).addClass('active');
        $('.c_pull_request_content').each(function(index){
            $(this).hide();
        });
        $('#id_ajax_loading').show();
        if(action == 'commit') {
            load_commit_meta();
        } else if(action == 'diff') {
            load_diff_meta();
        }
    });
    load_commit_meta();
    $('#id_pull_merge').click(function(){
        $('#id_merge_output').show();
        var i = 0;
        var interval = setInterval(function() {
            i = i + 1;
            var j = i % 4;
            var html = '&gt; 正在进行 Pull Request，请耐心等候'
            for (var k = 0; k < j; k++) {
                html = html + '.'
            }
            $('#id_merge_output').html(html);
        }, 500);
        $('html, body').animate({ scrollTop: 0 }, 'fast');
        $('#id_merge_process').show();
        $('#id_merge_action').hide();
        $.post('/{{user_name}}/{{repo_name}}/pull/{{pullRequest.id}}/merge/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            if(json.result == 'success') {
                clearInterval(interval);
                $('#id_merge_output').html(json.output);
                if(json.returncode != 0) {
                    $('#id_merge_after').attr('href', '/{{user_name}}/{{repo_name}}/pull/{{pullRequest.id}}/');
                    $('#id_merge_after > button').removeClass('btn-primary').addClass('btn-danger').text('合并失败，请检查是否 存在冲突 或者 non-fast-forward');
                }
                $('#id_merge_after').show();
            }
        });
        return false;
    });
    $('#id_pull_reject').click(function(){
        $.post('/{{user_name}}/{{repo_name}}/pull/{{pullRequest.id}}/reject/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            if(json.result == 'success') {
                window.location.href = '/{{user_name}}/{{repo_name}}/pulls/';
            }
        });
        return false;
    });
    $('#id_pull_close').click(function(){
        $.post('/{{user_name}}/{{repo_name}}/pull/{{pullRequest.id}}/close/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            if(json.result == 'success') {
                window.location.href = '/{{user_name}}/{{repo_name}}/pulls/';
            }
        });
        return false;
    });
});
</script>
{% endblock %}
