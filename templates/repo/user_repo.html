{% extends "base.html" %}
{% block css %}
{% endblock %}
{% block container %}
<div class="page-header" style="margin-bottom: 18px; height: 52px; padding-bottom: 0px;">
        <h1 style="float: left; margin-right: 30px">:-), {{ user_name }}的仓库列表</h1><div style="float: left" class="btn-group">
          <button data-toggle="dropdown" class="btn btn-small dropdown-toggle">查看列表 <span class="caret"></span></button>
          <ul class="dropdown-menu">
            {% for repo in repo_list %}
            <li><a href="/{{ user_name }}/{{ repo.name }}/">{{ repo.name }}</a></li>
            {% endfor %}
            <li class="divider"></li>
            <li><a href="/{{ user.username }}/repo/edit/0/">+ 创建新的仓库</a></li>
            <!--li><a href="/settings/repo/">+ 更多仓库管理</a></li-->
          </ul>
</div>
</div>
{% load humanize %}
{% for repo in repo_list %}
<div class="row" style="margin: 10px;">
    <div class="span7">
        <div class="c_repo" style="padding: 10px;">
            <h3>☺ 
            <a href="/{{ user_name }}/{{ repo.name }}/">{{ repo.name }}</a>
            <span style="float: right;">
            <a href="/{{ user_name }}/{{ repo.name }}/commits/" style="margin-right: 20px" rel="tooltip" data-original-title="commit 次数">♯ {{ repo.commit }}</a>
            <a href="/{{ user_name }}/{{ repo.name }}/clone_watch/" style="margin-right: 20px" rel="tooltip" data-original-title="watch 次数">♥ {{ repo.watch }}</a>
            <a href="/{{ user_name }}/{{ repo.name }}/clone_watch/" style="margin-right: 20px" rel="tooltip" data-original-title="fork 次数">♂ {{ repo.fork }}</a></span></h3>
            <div style="margin-left: 20px;">
                <h6>创建于{{ repo.create_time|date:"y/m/d" }}，最近更新{{ repo.modify_time|date:"y/m/d H:i" }}</h6> 
                <p>{{ repo.desc }}</p>
                <h6 id="i_{{repo.name}}_feed_history" style="display: none">最近</h6> 
                <ul id="i_{{repo.name}}">
                </ul>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
{% block js %}
<script src="/static/js/moment.min.js"></script>
<script src="/static/js/moment.zh-cn.js"></script>
<script>
/*global jQuery, window */
$(function(){
    moment.lang('zh-cn');
    orgi_repo_feed_map = {{repo_feed_map|safe}};
    var do_repo_feeds = function() {
        all_ids = [];
        for (x in orgi_repo_feed_map) {
            all_ids = all_ids.concat(orgi_repo_feed_map[x]);
        }
        all_ids_str = all_ids.join('_');
        $.ajax({
            url: '/ajax/feed/ids/',
            type: 'POST',
            data: {'ids_str': all_ids_str, csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
                //alert('');
            },
            success: function(json){
                repo_feed_map = {} 
                for (x in json.feeds) {
                    repo_feed_map[json.feeds[x]['id']] = json.feeds[x] 
                }
                for (x in orgi_repo_feed_map) {
                    html = []
                    if (orgi_repo_feed_map[x].length > 0) {
                        $('#i_' + x  + '_feed_history').show();
                    }
                    for (y in orgi_repo_feed_map[x]) {
                        if(repo_feed_map.hasOwnProperty(orgi_repo_feed_map[x][y])) {
                            feed = repo_feed_map[orgi_repo_feed_map[x][y]];
                            if(feed.relative_obj === undefined) {
                                continue;
                            }
                            if(feed.feed_type == 0) {
                                commit = feed.relative_obj;
                                html.push('<li><code><a href="/{{ user_name }}/' + commit.repo_name + '/">' + commit.commit_hash + '</a></code> ' + commit.subject + ' <span class="muted pull-right">' + commit.author + ' ' + moment(new Date(commit.committer_date*1000)).fromNow() + '</span></li>');
                            } else if(feed.feed_type == 300 || feed.feed_type == 301 || feed.feed_type == 302) {
                                issue = feed.relative_obj;
                                action = 'create issue';
                                detail = '';
                                if(feed.feed_type == 300) {
                                    action = 'create issue';
                                } else if(feed.feed_type == 301) {
                                    action = 'update issue';
                                } else if(feed.feed_type == 302) {
                                    action = 'change issue';
                                    detail = feed.first_refname;
                                }
                                html.push('<div style="margin-left: 0px;"><li style="margin: 1px">' + action + ' #' + issue.id + ' on <strong><a href="/'+ issue.username + '/' + issue.reponame +'/">' + issue.reponame + '</a></strong> ' + detail + '<div><a href="/'+issue.username+'/'+issue.reponame+'/issues/'+issue.id+'/">#' + issue.id + ' ' + issue.subject + '</a> <span class="muted">' + moment(new Date(issue.create_time*1000)).fromNow() + '</span></div>')
                                html.push('</li></div>');
                            }
                        }
                    }
                    $('#i_'+x).append(html.join(''));
                }
            }
        })
    };
    do_repo_feeds();
    $('.c_repo').hover(function() {
        $(this).css('background-color', '#D9EDF7');
    }, function(){
        $(this).css('background-color', '#FFFFFF');
    });
    $('.c_repo').tooltip({
      selector: "a[rel=tooltip]"
    })
});
</script>
{% endblock %}
