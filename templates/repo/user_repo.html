{% extends "base.html" %}

{% block body_class_name %}user{% endblock %}
{% block container_class_name %}dashboard{% endblock %}

{% block container %}

<div class="subhead">
  <div class="container">
    <h2 class="heading">我的仓库<span class="count">({{userprofile.get_total_repo}})</span></h2>
  </div>
</div>

<div class="content user-repos">
  <div class="container bubble">

    <div class="primary">

      {% load humanize %}

      {% for repo in repo_list %}
        <section class="repo c_repo">

          <div class="summary">
            <div class="heading">
              <h3><a href="/{{user_name}}/{{repo.name}}/">{{repo.name}}</a></h3>
              <p class="origin">fork自<a href="#">yuwen</a><span class="divider">/</span><a href="#">gitshell</a></p>
            </div>

            <div class="detail">
              <p class="desc">{{repo.desc}}</p>
            </div>
          </div>

          <ul class="meta">
            <li><a href="#"><span class="count">{{repo.commit}}</span><span class="meta-type">提交</span></a></li>
            <li><a href="#"><span class="count">{{repo.fork}}</span><span class="meta-type">派生</span></a></li>
            <li><a href="#"><span class="count">{{repo.watch}}</span><span class="meta-type">关注</span></a></li>
          </ul>

        </section>
      {% endfor %}

      <ul class="pagination">
        <li><a href="#">首页</a></li>
        <li><a href="#">上一页</a></li>
        <li class="active"><span>第1页</span></li>
        <li><a href="#">下一页</a></li>
        <li><a href="#">尾页</a></li>
      </ul>

    </div>

    <aside class="sidebar">

      <div class="create section">
        <div class="inner">
          <a href="/{{user.username}}/repo/create/" class="btn">新建仓库</a>
          <p>还可以创建<span>98</span>个仓库</p>
        </div>
      </div>

      {% comment %}
        <section class="capacities section">
          <div class="inner">
          <div class="item">
              <div class="dt">仓库数<span class="used">{{userprofile.get_total_repo}}</span><span class="divider">/</span><span class="capacity">100</span></div>
              <div class="progress">
                <div class="bar" style="width: {{userprofile.get_used_repo_percent}}%;"></div>
              </div>
            </div>

            <div class="item">
              <div class="dt">仓库配额<span class="used">{{userprofile.get_readable_used_quote}}</span><span class="divider">/</span><span class="capacity">{{userprofile.get_readable_quote}}</span></div>
              <div class="progress progress-danger">
                <div class="bar" style="width: {{userprofile.get_used_quote_percent}}%;"></div>
              </div>
            </div>
          </div>
        </section>
      {% endcomment %}

      <section class="activity section">
        <h2 class="heading">最近活动的仓库</h2>
        <ul class="nav nav-list">
          {% for repo in repo_list|slice:':6' %}
          <li><i class="icon-lock"></i><a href="/{{user_name}}/{{repo.name}}/"><span class="user">{{user_name}}</span><span class="divider">/</span><span class="repo-name">{{repo.name}}</span></a></li>
          {% endfor %}
        </ul>
      </section>
    </aside>

  </div>
</div>

{% endblock %}

{% block js %}
    <script>
    $(function(){
        moment.lang('zh-cn');
        orgi_repo_feed_map = {{repo_feed_map|safe}};
        var do_repo_feeds = function() {
            all_ids = [];
            for (x in orgi_repo_feed_map) {
                all_ids = all_ids.concat(orgi_repo_feed_map[x]);
            }
            all_ids_str = all_ids.join('_');
            $.ajax({
                url: '/ajax/feed/ids/',
                type: 'POST',
                data: {'ids_str': all_ids_str, csrfmiddlewaretoken: '{{csrf_token}}'},
                dataType: 'json',
                timeout: 10000,
                error: function(){
                    //alert('');
                },
                success: function(json){
                    var repo_feed_map = {};
                      for (x in json.feeds) {
                          repo_feed_map[json.feeds[x]['id']] = json.feeds[x] 
                      }
                    for (x in orgi_repo_feed_map) {
                        html = []
                        if (orgi_repo_feed_map[x].length > 0) {
                          $('#i_' + x  + '_feed_history').show();
                        }
                        for (y in orgi_repo_feed_map[x]) {
                            if(repo_feed_map.hasOwnProperty(orgi_repo_feed_map[x][y])) {
                                feed = repo_feed_map[orgi_repo_feed_map[x][y]];
                                if(feed.relative_obj === undefined) {
                                    continue;
                                }
                                if(feed.feed_type == 0) {
                                    commit = feed.relative_obj;
                                    html.push('<li><img src="https://gravatar.com/avatar/{{user_name}}?s=14" alt="{{user_name}}"><a href="/{{user_name}}/' + commit.repo_name + '/" class="hash">' + commit.commit_hash + '</a>' + commit.subject + ' <span class="date">' + moment(new Date(commit.committer_date*1000)).fromNow() + '</span></li>');
                                /*
                                } else if(feed.feed_type == 300 || feed.feed_type == 301 || feed.feed_type == 302) {
                                    issue = feed.relative_obj;
                                    action = '创建了新的issue';
                                    detail = '';
                                    if(feed.feed_type == 300) {
                                        action = '创建了新的issue';
                                    } else if(feed.feed_type == 301) {
                                        action = '更新了issue';
                                    } else if(feed.feed_type == 302) {
                                        action = '更改了issue';
                                        detail = feed.first_refname;
                                    }
                                    html.push('<li>' + action + ' #' + issue.id + '在仓库<strong><a href="/'+ issue.username + '/' + issue.reponame +'/">' + issue.reponame + '</a></strong> ' + detail + '<div><a href="/'+issue.username+'/'+issue.reponame+'/issues/'+issue.id+'/">#' + issue.id + ' ' + issue.subject + '</a> <span class="muted">' + moment(new Date(issue.create_time*1000)).fromNow() + '</span></div>')
                                  */
                                  html.push('</li>');
                                }
                            }
                        }
                        $('#i_'+x).append(html.join(''));
                    }
                }
            })
        };
        do_repo_feeds();
        $('.c_repo').tooltip({ selector: "a[rel=tooltip]" });

        /*
        $('.repo').hover(
          function(){
            $(this).find('.meta').show();
          },function(){
            $(this).find('.meta').hide();
          }
        );
        */
    });
    </script>
{% endblock %}
