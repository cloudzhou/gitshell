{% extends "repo/repo.html" %}

{% block subcontainer %}
<div class="branch-list bubble" id="branches">

  {# TODO| 判断出访问者权限加载不同的内容 #}
  {% if branches %}
  <div class="header">
    <h2 class="heading">分支<span class="count">{{repo_name.branches.count}}</span></h2>
    {% if is_repo_member %}
    <a href="#branch-manage" class="btn branch-manage"><i class="icon-cog"></i><span>管理</span></a>
    {% endif %}
  </div>
  {% else %}
    {% if is_repo_member %}
    <p class="info">没有分支。<a href="#" class="btn btn-success">创建一个新的分支</a></p>
    {% else %}
    <p class="info"><img src="/static/img/icons/alert-triangle-yellow.png" alt="">没有分支，或者没有查看提交信息权限，<em>半公开和私有项目需要申请成为成员才能查看提交信息</em></p>
    {% endif %}
  {% endif %}

</div>
{% endblock %}

{% block subjs %}
<script>
  $(function(){
    $.post('/{{user_name}}/{{repo_name}}/refs/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
      var html = [];
      var detail_commit = json.refs_meta.detail_commit;
      var branches = json.refs_meta.branches;
      var current_refs = '{{refs}}';
      for(x in branches) {
        html.push('<section class="branch"><div class="summary">');
        var branch = branches[x];
        var commit = detail_commit[branch];
        html.push('<h2 class="name"><a href="/{{user_name}}/{{repo_name}}/tree/' + branch + '">' + branch + '</a></h2>');
        html.push('<p class="last-commit">' + commit.committer_name + '<span class="unixtime">' + commit.committer_date + '</span>更新</p></div>');
        html.push('<ul class="actions">');
        html.push('<li><a href="/{{user_name}}/{{repo_name}}/compare/' + branch + '/" class="btn btn-success branchAction btn-mini"><i class="icon-random"></i>比较</a></li>');
        html.push('<li><a href="/{{user_name}}/{{repo_name}}/refs/graph/' + branch + '/" class="btn btn-mini branchAction"><i class="icon-adjust"></i>统计</a></li>');
        html.push('<li><a href="/{{user_name}}/{{repo_name}}/refs/create/' + branch + '/" class="btn btn-success btn-mini branchAction hide"><i class="icon-pencil"></i>创建新分支</a></li>');
        if(branch != 'master') {
          html.push('<li><a href="javascript:;" data-branch="' + branch + '"class="btn btn-danger btn-mini branchAction hide branchDelete"><i class="icon-remove"></i>删除</a></li>');
        }
        html.push('</ul>');
        html.push('</section>');
      }
      $('#branches').append(html.join(''));
    });
    $('.branch-manage').click(
        function(e){
          e.preventDefault();
          var txt = $(this).children('span').text();
          $(this).children('span').text( txt == '管理' ? '取消' : '管理' );
          $('.branchAction').toggle();
        });
    $('.branchDelete').click(
        function(){
          var branch = $(this).data('branch');
          var tr = $(this).parents('tr');
          $.post('/{{user_name}}/{{repo_name}}/refs/branch/delete/' + branch + '/', {csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
            tr.hide();
          });
        });

  });
</script>
{% endblock %}
