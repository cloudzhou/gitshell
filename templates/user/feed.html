{% extends "user/home_base.html" %}
{% block css %}
{% endblock %}
{% block subcontainer %}
<div class="row" style="">
    <div id='feeds_container' class="span7">
    <img id='feeds_loading' style="margin-left: 50px" src='/static/img/loading.gif'>
    </div>
</div>
{% endblock %}
{% block js %}
<script>
/*global jQuery, window */
$(function(){
    moment.lang('zh-cn');
    // TODO
    var orgi_feeds = {{ feeds_as_json|safe }}
    var sorted_feeds = []
    var do_orgi_feeds = function() {
        all_ids = []
        all_feeds = []
        for (x in orgi_feeds) {
            all_feeds = all_feeds.concat(orgi_feeds[x]);
        } 
        all_feeds.sort(function(a,b) {
            return a[1] - b[1];
        })
        var i = 0;
        var pre_feed_id = 0;
        for (x in all_feeds) {
            feed_id = all_feeds[x][0]
            if(pre_feed_id != feed_id) {
                i++;
                all_ids.push(feed_id);
            }
            pre_feed_id = feed_id
            if(i >= 100) { break; }
        }
        all_ids_str = all_ids.join('_');
        $.ajax({
            url: '/ajax/feed/ids/',
            type: 'POST',
            data: {'ids_str': all_ids_str, csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
                //alert('');
            },
            success: function(json){
                ordered_date = []
                ordered_date_reponame = {}
                display_feeds_map = {}
                feeds = json.feeds
                gravatarmap = json.gravatarmap
                feeds.sort(function(a,b) {
                    return b.committer_date - a.committer_date;
                })
                for(x in feeds) {
                    feed = feeds[x];
                    feed_date_str = moment(new Date(feed.committer_date*1000)).format('MM/DD');
                    feed_repo_name = feed.repo_name;
                    if(!display_feeds_map[feed_date_str]) {
                        ordered_date.push(feed_date_str);
                        display_feeds_map[feed_date_str] = {};
                    }
                    if(!display_feeds_map[feed_date_str][feed_repo_name]) {
                        if(!ordered_date_reponame[feed_date_str]) {
                            ordered_date_reponame[feed_date_str] = [];
                        }
                        ordered_date_reponame[feed_date_str].push(feed_repo_name);
                        display_feeds_map[feed_date_str][feed_repo_name] = [];
                    }
                    display_feeds_map[feed_date_str][feed_repo_name].push(feed);
                }
                html = []
                for(x in ordered_date) {
                    feed_date = ordered_date[x];
                    html.push('<div class="page-header" style="margin: 0px; padding-bottom: 10px"><h4 class="muted"> ' + feed_date + ' </h4></div><div class="feedtime" style="padding: 10px;"><h3><img style="margin-right: 10px" src="https://gravatar.com/avatar/{{ userprofile.imgurl }}?s=32"/><a href="/{{ user.username }}/">{{ user.username }}</a>...</h3>');
                    for(y in ordered_date_reponame[ordered_date[x]]) {
                        feed_reponame = ordered_date_reponame[ordered_date[x]][y];
                        html.push('<div style="margin-left: 50px;"><p>commit 到 <a href="">' + feed_reponame + '</a></p><ul>');
                        for(z in display_feeds_map[feed_date][feed_reponame]) {
                            feed = display_feeds_map[feed_date][feed_reponame][z];
                            html.push('<li style="margin: 1px"><code><a href="">' + feed.commit_hash + '</a></code> ' + feed.subject + ' <span class="muted pull-right">' + moment(new Date(feed.committer_date*1000)).fromNow() + '</span></li>');
                        }
                        html.push('</ul></div>');
                    }
                    html.push('</div>')
                }
                $('#feeds_container').append(html.join(''));
                if(ordered_date.length == 0) {
                    $('#feeds_container').append('还没有提交信息');
                }
                $('#feeds_loading').remove()
            }
        });
    };
    do_orgi_feeds();
    $('.feedtime').live('mouseover mouseout', function(event) {
        if (event.type == 'mouseover') {
            $(this).css('background-color', '#D9EDF7');
        } else {
            $(this).css('background-color', '#FFFFFF');
        }
    });
});
</script>
{% endblock %}
