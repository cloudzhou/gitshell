{% extends "user/user_base.html" %}
{% block left_sub_container %}
        <style>
.user_chart {min-width: 400px; height: 200px; margin: 0 auto}
        </style>
        <div class="page-header small_page-header">
            <h2>最近 <small><a href="/{{gsuser.username}}/active/" class="more">more</a></small></h2>
        </div>
        <div>
            <table class="table table-striped zero_border_table">
                <thead>
                  <tr>
                    <th class="span1">事件</th>
                    <th class="span5">详细</th>
                  </tr>
                </thead>
                <tbody id="id_lastest_active">
                </tbody>
            </table>
        </div>
        <div class="page-header small_page-header c_user_stats" style="display: none">
            <h2>统计<small><span><a href="/stats/{{gsuser.username}}/" class="more">more</a></small></span></h2>
        </div>
        <div class="c_user_stats" style="display: none">
            <div id="figure-a" class="figure lg">
                <div id="id_month_container" class="user_chart"></div>
                <div class="muted">统计最近一月 <strong>commit</strong> 次数 异步统计，仅供参考</div>
            </div>
        </div>
        <div class="page-header small_page-header">
            <h2>仓库<small><a href="/{{gsuser.username}}/repo/" class="more">more</a></small></h2>
        </div>
        <div>
            <table class="table table-striped zero_border_table">
                <thead>
                    <tr>
                        <th class="span1">名称</th>
                        <th class="">简介</th>
                    </tr>
                </thead>
                <tbody>
                {% for repo in repos %}
                    <tr>
                        <td><a href="/{{gsuser.username}}/{{repo.name}}/">{{repo.name}}</a></td>
                        <td>{{repo.desc}}
                        <span class="muted">(<span style="display:none" class="c_unixtime">{{repo.modify_time|date:"U"}}</span>)</span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="page-header small_page-header">
            <h2>关注仓库<small><a href="/{{gsuser.username}}/watch/repo/" class="more">more</a></small></h2>
        </div>
        <div>
            <table class="table table-striped zero_border_table">
                <thead>
                    <tr>
                        <th class="span1">名称</th>
                        <th class="">简介</th>
                    </tr>
                </thead>
                <tbody>
                {% for watch_repo in watch_repos %}
                    <tr>
                        <td><a href="/{{watch_repo.username}}/{{watch_repo.name}}/">{{watch_repo.name}}</a></td>
                        <td>{{watch_repo.desc}}
                        <span class="muted">(<span style="display:none" class="c_unixtime">{{watch_repo.modify_time}}</span>)</span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="page-header small_page-header">
            <h2>关注<small><a href="/{{gsuser.username}}/watch/user/" class="more">more</a></small></h2>
        </div>
        <div>
            <table class="table table-striped zero_border_table">
                <thead>
                    <tr>
                        <th class="span2">用户</th>
                        <th class="span5">简介</th>
                    </tr>
                </thead>
                <tbody>
                {% for watch_user in watch_users %}
                    <tr>
                        <td><img src="https://gravatar.com/avatar/{{watch_user.imgurl}}?s=32"/> <a href="/{{watch_user.username}}/">{{watch_user.username}}</a></td>
                        <td style="vertical-align: middle">{{watch_user.tweet}}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="page-header small_page-header">
            <h2>被关注 <small><a href="/{{gsuser.username}}/watch/user/" class="more">more</a></small></h2>
        </div>
        <div>
            <table class="table table-striped zero_border_table">
                <thead>
                    <tr>
                        <th class="span2">用户</th>
                        <th class="span5">简介</th>
                    </tr>
                </thead>
                <tbody>
                {% for bewatch_user in bewatch_users %}
                    <tr>
                        <td><img src="https://gravatar.com/avatar/{{bewatch_user.imgurl}}?s=32"/> <a href="/{{bewatch_user.username}}/">{{bewatch_user.username}}</a></td>
                        <td style="vertical-align: middle">{{bewatch_user.tweet}}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
{% endblock %}
{% block right_sub_container %}
        {% if userprofile.resume %}
        <div id="id_user_resume">
            <h4 style="margin-bottom: 8px; font-weight: normal; color: #999999;">简历:</h4>
            <blockquote>
                <div id="id_user_resume_content" style="display:none">{{ userprofile.resume }}</div>
            </blockquote>
        </div>
        {% endif %}
        <div id="id_user_recommends">
            <h4 style="margin-bottom: 8px; font-weight: normal; color: #999999;">评论:
                <small><a href="/{{gsuser.username}}/watch/recommend/" class="more">more</a></small></h4>
            <blockquote style="border-left-width: 0px;">
                {% for i in kk %}
                <span>作为gitshell开发者，知识全面，为人谦和</span>
                <small style="margin-left: 10px; margin-bottom:6px"><a href="">cloudzhou</a> git开发者</small>
                {% endfor %}
                <form class="form-inline" action="/{{user.username}}/recommends/" method="post">
                    {% csrf_token %}
                    {{ recommendsForm.recommend }}
                    <button id="id_recommend_submit" class="btn hide" type="submit">确定</button>
                </form>
            </blockquote>
        </div>
{% endblock %}
{% block subjs %}
<script src="/static/js/app/highcharts/highcharts.js"></script>
<script src="/static/js/Markdown.Converter.js"></script>
<script src="/static/js/Markdown.Editor.js"></script>
<script src="/static/js/Markdown.Sanitizer.js"></script>
<script>
/*global jQuery, window */
$(function(){
    moment.lang('zh-cn');
{% if userprofile.resume %}
    var resume_md_converter = function() {
        var converter = new Markdown.getSanitizingConverter();
        var html = converter.makeHtml($('#id_user_resume_content').html());
        $('#id_user_resume_content').html(html);
        $('#id_user_resume_content').show();
    };
    resume_md_converter();
{% endif %}
    $('#id_recommend').attr('placeholder', '言简意赅评论一下他，希望你确实了解他');
    $('#id_recommend').addClass('input-xlarge');
    $('#id_recommend').click(function() {
        $('#id_recommend_submit').show();
    });
    $('#id_recommend').blur(function() {
        $('#id_recommend_submit').hide();
    });
    var orgi_feeds = {{ feeds_as_json|safe }}
    var sorted_feeds = []
    var do_orgi_feeds = function() {
        all_ids = []
        all_feeds = []
        for (x in orgi_feeds) {
            all_feeds = all_feeds.concat(orgi_feeds[x]);
        } 
        all_feeds.sort(function(a,b) {
            return a[1] - b[1];
        })
        var i = 0;
        var pre_feed_id = 0;
        for (x in all_feeds) {
            feed_id = all_feeds[x][0]
            if(pre_feed_id != feed_id) {
                i++;
                all_ids.push(feed_id);
            }
            pre_feed_id = feed_id
            if(i >= 5) { break; }
        }
        all_ids_str = all_ids.join('_');
        $.ajax({
            url: '/ajax/feed/ids/',
            type: 'POST',
            data: {'ids_str': all_ids_str, csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
                //alert('');
            },
            success: function(json){
                ordered_date = []
                ordered_date_reponame = {}
                display_feeds_map = {}
                feeds = json.feeds
                gravatarmap = json.gravatarmap
                feeds.sort(function(a,b) {
                    return b.committer_date - a.committer_date;
                })
                html = []
                for(x in feeds) {
                    feed = feeds[x]
                    feed_date_str = moment(new Date(feed.committer_date*1000)).format('MM/DD');
                    html.push('<tr><td><a href="/' + feed.user_name + '/' + feed.repo_name + '/">' + feed.repo_name + '</a></td><td>' + feed.subject + ' <span class="muted">(' + feed_date_str + ')</span></td></tr>')
                }
                $('#id_lastest_active').html(html.join(''));
                if(feeds.length == 0) {
                    $('#id_lastest_active').html('<tr><td colspan=3>还没有活跃信息</td></tr>');
                }
            }
        });
    };
    do_orgi_feeds();
    $('.c_unixtime').each(function(index){ 
        $(this).html(moment(new Date($(this).html()*1000)).fromNow());
        $(this).show();
    });
    var last30days = {{last30days}};
    var last30daysAsCat = [];
    for(x in last30days) {
        last30daysAsCat.push(new Date(last30days[x]*1000).getDate());
    }
    last30daysAsCat.reverse()
    var last30days_commit = {{last30days_commit}};
    var last30daysAsData = [];
    for(x in last30days) {
        if(last30days[x] in last30days_commit) {
            last30daysAsData.push(last30days_commit[last30days[x]]);
            continue;
        }
        last30daysAsData.push(0);
    }
    last30daysAsData.reverse();
if(Object.keys(last30days_commit).length > 0) {
    $('.c_user_stats').show();
    var month_chart = new Highcharts.Chart({
        chart: { renderTo: 'id_month_container', type: 'line'},title: {text: ''},
        yAxis: { title: { text: '提交次数' } },
        plotOptions: { line: { dataLabels: { enabled: true }, enableMouseTracking: false } },
        xAxis: { categories: last30daysAsCat },
        series: [{ name: '1 月提交', data: last30daysAsData }]
    });
}
});
</script>
{% endblock %}
