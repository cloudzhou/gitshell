{% extends "user/user_base.html" %}

{% block primary %}
<div class="span left">
    <div class="item">
        <h2 class="heading">最近活跃</h2>
        <div id="id_lastest_active" class="list"></div>
    </div>
</div>
{% endblock %}
{% block subjs %}
<script>
$(function(){
    var orgi_feeds = {{ feeds_as_json|safe }}
    var sorted_feeds = []
    var do_orgi_feeds = function() {
        all_ids = []
        all_feeds = []
        for (x in orgi_feeds) {
            all_feeds = all_feeds.concat(orgi_feeds[x]);
        } 
        all_feeds.sort(function(a,b) {
            return a[1] - b[1];
        })
        var i = 0;
        var pre_feed_id = 0;
        for (x in all_feeds) {
            feed_id = all_feeds[x][0]
            if(pre_feed_id != feed_id) {
                i++;
                all_ids.push(feed_id);
            }
            pre_feed_id = feed_id
            if(i >= 100) { break; }
        }
        all_ids_str = all_ids.join('_');
        $.ajax({
            url: '/ajax/feed/ids/',
            type: 'POST',
            data: {'ids_str': all_ids_str, csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            timeout: 10000,
            error: function(){
                //alert('');
            },
            success: function(json){
                ordered_date = []
                ordered_date_reponame = {}
                display_feeds_map = {}
                feeds = json.feeds
                gravatar_dict = json.gravatar_dict
                feeds.sort(function(a,b) {
                    return b.committer_date - a.committer_date;
                })
                html = []
                for(x in feeds) {
                    feed = feeds[x]
                    if(feed.relative_obj === undefined) {
                        continue;
                    }
                    if(feed.feed_type == 0) {
                        commit = feed.relative_obj;
                        feed_date_str = moment(new Date(commit.committer_date*1000)).format('MM/DD');
                                                html.push('<li><h3 class="heading"><a href="#">' + commit.repo_name + '</a></h3><p>' + commit.subject + '<span class="modified">' + feed_date_str + '</span></p></li>')
                    } else if(feed.feed_type == 300 || feed.feed_type == 301 || feed.feed_type == 302) {
                        issue = feed.relative_obj;
                        action = 'create issue';
                        detail = '';
                        if(feed.feed_type == 300) {
                            action = 'create issue';
                        } else if(feed.feed_type == 301) {
                            action = 'update issue';
                        } else if(feed.feed_type == 302) {
                            action = 'change issue';
                            detail = feed.first_refname;
                        }
                        feed_date_str = moment(new Date(issue.create_time*1000)).format('MM/DD');
                                                html.push('<li><h3 class="heading"><a href="/' + issue.username + '/' + issue.reponame + '/">' + issue.reponame + '</a></h3><p>' + action + ' #' + issue.id + ' on <a href="/'+ issue.username + '/' + issue.reponame +'/">' + issue.reponame + '</a></p><p>' + detail + '<a href="/'+issue.username+'/'+issue.reponame+'/issues/'+issue.id+'/">#' + issue.id + ' ' + issue.subject + '</a><span class="date">'+ feed_date_str +'</span></p></li>')
                    }
                }
                $('#id_lastest_active').html(html.join(''));
                if(feeds.length == 0) {
                    $('#id_lastest_active').html('<li><p>还没有活跃信息</p></li>');
                }
            }
        });
    };
    do_orgi_feeds();
    $('.unixtime').each(function(index){ 
        $(this).html(moment(new Date($(this).html()*1000)).fromNow());
        $(this).show();
    });
});
</script>
{% endblock %}
